---
title: "WA Sea Turtle Database (WAStD) analysis"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
    code_folding: hide
    theme: lumen
vignette: >
  %\VignetteIndexEntry{wastd}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
  area_name: 'Port Hedland'
---
<style type="text/css">
body, .main-container {
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Data
Data for this summary is supplied from WAStD.
In this report, we filter the data to the location `r params$area_name`.

```{r setup}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
library(wastdr)
drake::loadd("wastd_data")
```


```{r filter_data}
fn <- here::here("inst/reports", wastdr::urlize(params$area_name))
if (!fs::file_exists(fn)) {
  wastdr::wastdr_msg_info(glue::glue("Creating dir {fn}"))
  fs::dir_create(fn, recurse = TRUE)
}

class(wastd_data)
```

```{r}
x <- wastd_data %>% 
  wastdr::filter_wastd_turtledata(area_name = params$area_name)
```

```{r export_data}
x %>% wastdr::export_wastd_turtledata(outdir = fn)
```

The data was downloaded from WAStD on `r wastd_data$downloaded_on`.

# Data summaries

## Turtle tracks and nests season totals
Tracks and nests are tallied by type and grouped by

* season: numeric year of season start, i.e. 2019 = season 2019-20
* nest age:
  * fresh - made last night,
  * old - made before last night, 
  * missed - at night during tagging
* species: "cheloniidae-fam" = species unknown

To see only missed tracks, type "mis" into the filter box of column "(details_)nest_age".

```{r}
wastd_nesting_type_by_season_age_species <-
  x$tracks %>% 
  wastdr::nesting_type_by_area_season_age_species() %>% 
  dplyr::arrange(-season)
  
wastd_nesting_type_by_season_age_species %>% 
  reactable::reactable(filterable = T, sortable = T)

# wastd_nesting_type_by_season_age_species %>% 
#   readr::write_csv(here::here(fn, "nesting_type_by_season_age_species_2017.csv"))
```


## Turtle tracks and nests daily totals
The same data, but grouped by day instead of season.

```{r}
# odkc_nesting_type_by_day_type_species <- 
#   odkc_data$tracks %>% 
#   wastdr::sf_as_tbl() %>% 
#   wastdr::nesting_type_by_season_calendarday_age_species_odkc() 

# odkc_nesting_type_by_day_type_species %>% 
#   reactable::reactable(filterable = T, sortable = T) 

# odkc_nesting_type_by_day_type_species %>% 
#   readr::write_csv(here::here(fn, "nesting_type_by_day_age_species_2019.csv"))

wastd_nesting_type_by_day_age_species <-
  x$tracks %>% 
  wastdr::nesting_type_by_season_calendarday_age_species() %>% 
  dplyr::arrange(-season)
  
wastd_nesting_type_by_day_age_species %>% 
  reactable::reactable(filterable = T, sortable = T)

# wastd_nesting_type_by_day_age_species %>% 
#   readr::write_csv(here::here(fn, "nesting_type_by_day_age_species_2017.csv"))
```

## Night recaptures by species year and total TAG
Bob.

## Annual new turtles by species year and total WAMTRAM
Bob.

## Annual recaptures by species year and total WAMTRAM
Bob.

## Annual total turtles (individuals) by species year and total WAMTRAM
Bob.

## Annual total turtle emergences 
Tracks and nests are combined and tallied, grouped by season and species to form
the total number of emergences in one season.
This data needs to be added to the number of tagged turtles from WAMTRAM.

```{r}
# odkc_data$tracks %>% 
#   wastdr::sf_as_tbl() %>% 
#   wastdr::exclude_training_species_odkc() %>% 
#   dplyr::group_by(season, details_species) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup() %>%
#   reactable::reactable(filterable = T, sortable = T)

x$tracks %>% 
  wastdr::exclude_training_species() %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season) %>%
  reactable::reactable(filterable = T, sortable = T)
```

## Number of nests tagged 
Tagged nests are exported as individual records of encounters with tagged nests
(including initial tagging and resighting).
We show both the individual records and the season tallies.

```{r}
# odkc_tagged_nests <- odkc_data$tracks %>% 
#   wastdr::sf_as_tbl() %>% 
#   wastdr::exclude_training_species_odkc() %>% 
#   dplyr::filter(nest_nest_tagged == "yes")
# Individual records 2019-20
# odkc_tagged_nests %>%
#   reactable::reactable(filterable = T, sortable = T)
# odkc_tagged_nests %>% 
  # readr::write_csv(here::here(fn, "tagged_nests_2019.csv"))
# Season tally 2019-20  
# odkc_tagged_nests %>% 
#   dplyr::group_by(season, details_species) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup() %>%
#   reactable::reactable(filterable = T, sortable = T)

wastd_tagged_nests <- x$nest_tags %>% 
  wastdr::exclude_training_species() 
# Individual records 2017-19
wastd_tagged_nests %>%
  reactable::reactable(filterable = T, sortable = T)
# wastd_tagged_nests %>%
   # readr::write_csv(here::here(fn, "tagged_nests_2017.csv"))
# Season tally 2017-19
wastd_tagged_nests %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season) %>%
  reactable::reactable(filterable = T, sortable = T)
```

## Number of nests found
The data here is the same as above, 
nest type "successful-crawl" (confirmed fresh nest) and "hatched nest".

```{r}
# odkc_nests <- odkc_data$tracks %>% 
#   wastdr::sf_as_tbl() %>% 
#   wastdr::exclude_training_species_odkc() %>% 
#   dplyr::filter(details_nest_type %in% c("successful-crawl", "hatched nest")) %>% 
#   dplyr::group_by(season, details_species, details_nest_type) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup()
# odkc_nests %>%
#   reactable::reactable(filterable = T, sortable = T)
# odkc_nests %>% 
  # readr::write_csv(here::here(fn, "fresh_and_hatched_nests_2019.csv"))

wastd_nests <- x$tracks %>% 
  wastdr::exclude_training_species() %>% 
  dplyr::filter(nest_type %in% c("successful-crawl", "hatched nest")) %>% 
  dplyr::group_by(season, species, nest_type) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season)
wastd_nests %>%
  reactable::reactable(filterable = T, sortable = T)
# wastd_nests %>% 
  # readr::write_csv(here::here(fn, "fresh_and_hatched_nests_2017.csv"))
```

## Nest loggers

Nest loggers, n is number of encounters which includes both initial deployment 
and any recorded re-sighting.
```{r}
# odkc_data$tracks_log %>% 
#   wastdr::sf_as_tbl() %>% 
#   dplyr::group_by(logger_id) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup() %>%
#   reactable::reactable(filterable = T, sortable = T)

# x$tracks$logger_found %>% unique() # all NA
```

## Hatching and emergence success 

Data shown here is summarised by season, and exported as individual 
nest excavation records. Data is split up by source between new season (2019-20)
and previous seasons.

```{r}
# odkc_data$tracks_egg %>% 
#   wastdr::sf_as_tbl() %>% 
#   wastdr::add_hatching_emergence_success_odkc() %>% 
#   wastdr::hatching_emergence_success_odkc() %>%
#   reactable::reactable(filterable = T, sortable = T)
# odkc_data$tracks_egg %>% 
  # wastdr::sf_as_tbl() %>%
  # readr::write_csv(here::here(fn, "nest_excavations_hatching_emergence_success_2019.csv"))

x$nest_excavations %>% 
  wastdr::hatching_emergence_success() %>% 
  dplyr::arrange(-season) %>%
  reactable::reactable(filterable = T, sortable = T)
# x$nest_excavations %>%
  # readr::write_csv(here::here(fn, "nest_excavations_hatching_emergence_success_2017.csv"))
```

TODO Plot HS/ES time series to show different season length / survey effort


## Fan angle data
Fan angle data is only exported here for now.
The map shows nests with recorded hatchling fans from 2019-20.

TODO discuss meaningful visualisations

```{r}
# odkc_fans <- odkc_data$tracks %>% 
#   dplyr::filter(nest_fan_angles_measured == "yes")
# odkc_fans %>% 
  # wastdr::sf_as_tbl() %>%
  # readr::write_csv(here::here(fn, "fan_angles_main_2019.csv"))

# odkc_data$tracks_fan_outlier %>% 
  # wastdr::sf_as_tbl() %>%
  # readr::write_csv(here::here(fn, "fan_angles_outliers_2019.csv"))

# odkc$tracks_light %>% 
  # wastdr::sf_as_tbl() %>%
  # readr::write_csv(here::here(fn, "fan_angles_lightsources_2019.csv"))

# odkc_fans %>% wastdr::map_tracks_odkc()

# x$nest_fans %>%
  # readr::write_csv(here::here(fn, "fan_angles_main_2017.csv"))
# x$nest_fan_outliers %>%
  # readr::write_csv(here::here(fn, "fan_angles_outliers_2017.csv"))
# x$nest_lightsources %>%
  # readr::write_csv(here::here(fn, "fan_angles_lightsources_2017.csv"))
```

## Tag return crossovers from or to by year 
WAMTRAM

## Survey effort
The 2019-20 data has not been value-added by WAStD. Therefore, we calculate season
stats manually.

```{r}
# 2019-20 season
first_survey <- min(min(wastd_data$surveys$start_time), min(wastd_data$surveys$end_time))
last_survey <- max(max(wastd_data$surveys$start_time), max(wastd_data$surveys$end_time))
season_length <- first_survey - last_survey
```

The surveys span `r season_length` between `r first_survey` and 
`r last_survey`.

```{r}
# wastdr::map_sv_odkc(odkc_data$svs, odkc_data$sve, sites=odkc_data$sites)
# 
# svs_tally <- odkc_data$svs %>% 
#       wastdr::sf_as_tbl() %>%
#       dplyr::group_by(season, calendar_date_awst, site_name) %>% 
#       dplyr::tally() %>% 
#       dplyr::rename(no_start_surveys=n) %>% 
#       dplyr::ungroup()
#     
# sve_tally <- odkc_data$sve %>% 
#   wastdr::sf_as_tbl() %>%
#   dplyr::group_by(season, calendar_date_awst, site_name) %>% 
#   dplyr::tally() %>% 
#   dplyr::rename(no_end_surveys=n) %>% 
#   dplyr::ungroup()
# 
# grp <- c("season", "calendar_date_awst", "site_name")
# 
# svs_tally %>% 
#   dplyr::full_join(sve_tally, by = grp) %>% 
#   reactable::reactable(filterable = T)
```


A summary of past seasons follows. Note the dates are "turtle dates".

```{r, fig.width=10}
# x$surveys %>% 
#   wastdr::survey_count_heatmap(
#     placename = params$area_name, 
#     prefix = params$wamtram_an
#   )
x$surveys %>% 
  wastdr::survey_season_stats() %>%
  reactable::reactable(filterable = T, sortable = T)
```


## Number of volunteers each year
```{r}
# odkc_data$svs %>% 
#   wastdr::sf_as_tbl() %>% 
#   dplyr::group_by(season, reporter) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup() %>%
#   reactable::reactable(filterable = T, sortable = T)

x$surveys %>% 
  dplyr::group_by(season, reporter) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season) %>%
  reactable::reactable(filterable = T, sortable = T)
```

## Number of Indigenous employee days
Scott

## List of sat tags applied in last three years
Seaturtle.org or WAMTRAM
