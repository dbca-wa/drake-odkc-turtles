---
title: 'Delambre Island  Flatback Turtle Monitoring Report - Appendix 1: Data'
author: "NWSFTCP, DBCA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_width: 10
    fig_height: 6
    code_folding: hide
    theme: lumen
  pdf_document:
    toc: yes
    toc_depth: '3'
vignette: |
  %\VignetteIndexEntry{wastd} %\VignetteEncoding{UTF-8} %\VignetteEngine{knitr::rmarkdown}
params:
  area_name: Delambre Island
editor_options:
  markdown:
    wrap: 72
---

```{css, echo=FALSE}
body, .main-container {max-width: 100%; margin-left: auto; margin-right: auto;}
```

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
library(wastdr)
library(sparkline)
library(ggplot2)
library(gt)
library(reactable)

# WAStD data from ETL
drake::loadd("wastd_data")

# WAMTRAM data from manual export
# https://dpaw.sharepoint.com/teams/TurtlesRioTinto/Shared%20Documents/Forms/AllItems.aspx?viewid=737abde6%2D72b7%2D4293%2D92d3%2D4e1db0bfaf3a&id=%2Fteams%2FTurtlesRioTinto%2FShared%20Documents%2FGeneral%2F2021%2D03%2D26%20DEL%20and%20WPTP%2FTagging%20data%20export%20%2D%20new%20format
# data export new format saved to data/wamtram.csv
species_lookup <- tibble::tribble(
  ~ species_code, ~ species,
  "HK", "eretmochelys-imbricata",
  "FB", "natator-depressus",
  "LB", "dermochelys-coriacea", 
  "GN", "chelonia-mydas"
) 

w2 <- here::here("data/wamtram.csv") %>% 
  readr::read_csv() %>% 
  janitor::clean_names() %>% 
  dplyr::left_join(species_lookup, by="species_code") %>% 
  dplyr::filter(turtle_status != "E") %>%
  dplyr::mutate(
    o_time = observed_time %>% tidyr::replace_na("00:00:00") %>% as.character(),
    o_datetime = glue::glue("{observation_date} {o_time} +08:00"),
    encounter_datetime_utc = lubridate::parse_date_time(
      o_datetime, 
      orders = c("dmYHMSz", "dmYz"), 
      tz="UTC"
      ) %>% lubridate::with_tz("UTC")
  ) %>% 
  wastdr::add_dates(date_col = "encounter_datetime_utc", parse_date = FALSE)

# Verify that dates are correct:
# w2 %>% 
#   dplyr::select(
#     observation_date, 
#     observed_time, 
#     o_time,
#     datetime, # same as encounter_datetime_utc
#     encounter_datetime_utc, 
#     calendar_date_awst, 
#     turtle_date) %>% 
#   View()
#   
# R> w2$datetime[[1]]
# [1] "1987-11-25 05:18:00 UTC"
# R> w2$encounter_datetime_utc[[1]] %>% lubridate::with_tz("Australia/Perth")
# [1] "1987-11-25 13:18:00 AWST"

# cols(
#   TURTLE_ID = col_double(),
#   SPECIES_CODE = col_character(),
#   IDENTIFICATION_CONFIDENCE = col_character(),
#   SEX = col_logical(),
#   TURTLE_STATUS = col_character(),
#   OBSERVATION_ID = col_double(),
#   OBSERVATION_STATUS = col_character(),
#   TAG_1 = col_character(),
#   TAG_2 = col_character(),
#   TAG_3 = col_character(),
#   TAG_4 = col_character(),
#   PIT_TAGS = col_character(),
#   OTHER_IDENTIFICATION = col_character(),
#   LOCATION_CODE = col_character(),
#   OBSERVATION_DATE = col_character(),
#   OBSERVED_TIME = col_time(format = ""),
#   OBSERVED_LOCATION_CODE = col_character(),
#   PLACE_CODE = col_character(),
#   ACTIVITY_CODE = col_character(),
#   BEACH_POSITION_CODE = col_character(),
#   NESTING = col_character(),
#   CLUTCH_COMPLETED = col_character(),
#   NUMBER_OF_EGGS = col_double(),
#   EGG_COUNT_METHOD = col_character(),
#   COMMENTS = col_character(),
#   CCL = col_double(),
#   CCW = col_double(),
#   DATUM_CODE = col_character(),
#   LATITUDE = col_double(),
#   LONGITUDE = col_double(),
#   LATITUDE_DEGREES = col_logical(),
#   LATITUDE_MINUTES = col_logical(),
#   LATITUDE_SECONDS = col_logical(),
#   LONGITUDE_DEGREES = col_logical(),
#   LONGITUDE_MINUTES = col_logical(),
#   LONGITUDE_SECONDS = col_logical(),
#   ZONE = col_double(),
#   EASTING = col_double(),
#   NORTHING = col_double(),
#   DAMAGE = col_character()
# )

# Rendered tables: gt
# Interactive tables: reactable
rt <- . %>% 
  reactable::reactable(
    ., 
    filterable = T, 
    sortable = T, 
    searchable = T,
    defaultColDef = reactable::colDef(html = TRUE)
  )

# Data export destination
zipfn <- wastdr::urlize(params$area_name)
fn <- here::here("inst/reports/rio", zipfn)
if (!fs::file_exists(fn)) {
  "Creating dir {fn}" %>% glue::glue() %>% wastdr::wastdr_msg_info()
  fs::dir_create(fn, recurse = TRUE)
}

# Data labels
pn <- params$area_name
pf <- "DEL"
ld <- here::here("inst/reports/delambre-island")

x <- wastd_data %>% 
  wastdr::filter_wastd_turtledata(area_name = params$area_name)

# Missed turtles during tagging
# We don't filter by track_age
# This includes "missed just now" from tagging, 
# "fresh" and "old" from morning track count.
wastd_missed_turtles <- 
  x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  dplyr::filter(
    nest_type %in% c(
      "successful-crawl", 
      "false-crawl", 
      "track-unsure", 
      "track-not-assessed")
  ) %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "missed") %>% 
  dplyr::ungroup() 
 
# B from night tagging
# unique(w2$turtle_status) "T" "Q" "N" "P" "A" "R" 
# processed: "T" "Q" "P" "A" "R" - missed: "N" NA
# new tag applied:
# "A" new tag
# "P" query new tagged - new on a turtle with tag scars and no PIT = not a new turtle
# "Q" query identity - a record flagged for curation, can become R or A
# "T" tagged
# "R" re-entered population - a curated record, was Q
#  
# no new tag applied:
# "N" non tagged
# NA  
# C captive
# E error data not to be used
# s salvage

# w2_processed_turtles = w2_tagged_turtles + w2_non_tagged_turtles
w2_processed_turtles <- w2 %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "processed") %>% 
  dplyr::ungroup()

w2_tagged_turtles <- w2 %>% 
  dplyr::filter(turtle_status %in% c("A", "P", "Q", "T", "R")) %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "tagged") %>% 
  dplyr::ungroup()

w2_non_tagged_turtles <- w2 %>% 
  dplyr::filter(turtle_status %in% c("N", NA, "C", "S")) %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "non_tagged") %>% 
  dplyr::ungroup()

# Total emergences = missed (WAStD) + processed (w2)
total_turtles <- dplyr::full_join(
  wastd_missed_turtles,
  w2_processed_turtles,
  by=c("species", "season", "turtle_date")
) %>% 
  dplyr::mutate(
    emergences = processed + missed,
    processed_pct = round(processed * 100 / (emergences), 2)
  ) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  dplyr::select(season, turtle_date, species, emergences, processed, missed, processed_pct) %>% 
  janitor::clean_names(case="sentence")

# Season x species tally of wastd_missed_turtles
missed_turtles_season_totals <- wastd_missed_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "missed", wt = missed) %>% 
  dplyr::ungroup() 

# Season x species tally of w2_processed_turtles
processed_turtles_season_totals <- w2_processed_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "processed", wt = processed) %>% 
  dplyr::ungroup() 

# Season x species tally of w2_tagged_turtles
tagged_turtles_season_totals <- w2_tagged_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "tagged", wt = tagged) %>% 
  dplyr::ungroup() 

# Season x species tally of w2_non_tagged_turtles
non_tagged_turtles_season_totals <- w2_non_tagged_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "non_tagged", wt = non_tagged) %>% 
  dplyr::ungroup() 

# Total turtles
total_turtles_season <- 
  missed_turtles_season_totals %>% 
  dplyr::full_join(processed_turtles_season_totals, by=c("species", "season")) %>% 
  # we skip tagged/non tagged as there is only one non tagged (historic sighting)
  # dplyr::full_join(tagged_turtles_season_totals, by=c("species", "season")) %>% 
  # dplyr::full_join(non_tagged_turtles_season_totals, by=c("species", "season")) %>% 
  dplyr::mutate(
    emergences = processed+missed,
    processed_pct = round(processed * 100 / (emergences), 2)) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  dplyr::select(season, species, emergences, processed, missed, processed_pct) %>% 
  janitor::clean_names(case="sentence")
```

# Data

In this report, we present combined Turtle Monitoring data from WAStD
(Turtle Nesting Census, "tracks") and the tagging database WAMTRAM2
(Turtle Tagging, "tagging") and filter the data to the location
`r params$area_name`.

The WAStD data was downloaded on `r wastd_data$downloaded_on` and
reflects all QA operations up to this date.

The WAMTRAM2 data was exported on 26 Feb 2021.

# Survey effort
Survey effort as shown here is calculated from surveys captured in WAStD.

The season length spans the dates of the first to the last survey of the season.
The single survey with a single turtle track in Aug 2019 contribute to the
unusual season length in 2019.

<!--
TODO
What's the story behind the single flatback false crawl in 21 Aug 2019?
https://wastd.dbca.wa.gov.au/admin/observations/turtlenestencounter/175285/change/
-->

The estimate of hours spent surveying is inflated in past seasons (2019 and earlier)
by incorrectly merged surveys which span either two night tagging shifts, or
a night tagging shift and a morning track count. The estimate of hours will be
more accurate after these merged surveys have been un-merged.

On days of night tagging and morning track counts there should be two surveys 
per date.


```{r survey_effort}
x$surveys %>% 
  wastdr::survey_season_stats()  %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Seasonal overview of survey effort"
  ) %>% 
  # gt::fmt_date(c("First day", "Last day")) %>% # Friday, October 20, 2017
  gt::tab_header(
    title="Seasonal overview of survey effort",
    subtitle="Survey stats grouped by rookery and season"
  )
```

```{r svy_plt_count}
x$surveys %>% plot_survey_count(placename = pn, prefix = pf, export = FALSE)
```

```{r svy_plt_hrs}
x$surveys %>% plot_survey_effort(placename = pn, prefix = pf, export = FALSE)
```

<!--
# List individual surveys with links to WAStD
# x$surveys %>% survey_show_detail() %>% rt

# Survey effort: numbers
# x$surveys %>% surveys_per_site_name_and_date() %>% rt
# x$surveys %>% list_survey_count()
# x$surveys %>% survey_hours_per_site_name_and_date() %>% rt
# x$surveys %>% list_survey_effort()
# x$surveys %>% survey_hours_per_person() %>% rt
# Heatmaps break on calendar years
# x$surveys %>% survey_count_heatmap(placename = pn, prefix = pf, export = FALSE)
# x$surveys %>% survey_hours_heatmap(placename = pn, prefix = pf, export = FALSE)
-->

# Nesting

## Season overview
Nesting census data (WAStD tracks) are shown for the last season (2020-21). 
Training records are excluded.

<!-- 
# TODO: show tagging in tracks_map_2020
-->

```{r tracks_map_2020}
x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  wastdr::filter_wastd_season(2020) %>% 
  wastdr::map_tracks(sites = x$sites, cluster = FALSE)
```


<!-- 

# 
# nest_type_by_day <- x$tracks %>% 
#   wastdr::filter_realspecies() %>% 
#   dplyr::group_by(site_name, season, calendar_date_awst, nest_type) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup()
#  
# ggplot2::ggplot(
#   data = nest_type_by_day,
#   mapping = ggplot2::aes(
#     x = tdate_as_fdate(calendar_date_awst), 
#     colour = nest_type
#   ) 
# ) +
#   ggplot2::geom_bar(ggplot2::aes(y = n),
#                     stat = "identity",
#                     color = "black",
#                     fill = "grey"
#   ) +
#   ggplot2::facet_grid(facets = ggplot2::vars(season), scales = "free_x") +
#   ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
#   NULL

SFO https://github.com/dbca-wa/wastd/issues/177

TABLE:

-   Total, mean, SD and range number of processed turtles
-   Total, mean, SD and range number of unique individuals
-   Total, mean, SD and range number of new turtles 
-   Total, mean, SD and range number of remigrants
-   Mean, SD, range of number of missed turtles per night, and
    percentage of missed turtles per night (compared to number of
    processed turtles)
-   Total, mean, SD and range number of nests (need to discuss
    methodology to QA data to identify nests)
-   Total, mean, SD and range number of false crawls
-   mean, SD and range nesting success
-   keep figure “Number of processed turtles per day” but add number of 
    missed turtles per day to the figure, staked histograms
-   add figure “Number of new and remigrant turtles per day” : 
    show the number of new turtles and remigrants each day (unique sighting, 
    not observations)
-   add figure “Nesting success”: show the number of false crawls and nests 
    each day + dashed line showing the mean

Inter-nesting interval and clutch frequency

TABLE:

-   mean, SD, range of inter-nesting interval in days + number of animals
-   mean, SD, range of clutch frequency
-   hide figure “nesting intervals”
-   add figure “Clutch Frequency”: show estimated number of turtles that lay 1 clutch, 2 clutches, 3 clutches, etc
 -->

## Total turtles

We calculate the **total number of turtle emergences per night** as the sum of
emergences from the following observations:

-   nesting females tagged at night (from WAMTRAM tagging - all records are a 
    processed turtle, nesting or not, tagged or not)
-   tracks of turtles missed during tagging (from WAStD tracks of any 
    nesting success type - success, unsure, or no success,
    with track age "missed just now")
-   tracks of turtles missed during tagging and then encountered during a
    nesting census beach walk the next morning (from WAStD tracks,
    tracks of of any nesting success type with track age 
    "new, made in past 24 hours")

We exclude hatched nests, incubating nests without a track (each are older than a
day), and body pits (which can be recorded, but are of little value).

We assume each record in WAMTRAM is a turtle emergence, be it tagged or not, and
nesting or not. We assume no record in WAMTRAM is duplicated in WAStD, i.e.
turtles are either captured on paper (WAMTRAM) or in a tablet (WAStD), but never
on both media.

We bin the numbers for tallying by the "turtle date", which is the
calendar date of the tagging night and extends to encounters past
midnight and on the next morning. 
Turtle date rolls over at noon and lags behind calendar date by 12 hours. 
Turtle date bins all recorded events from one nesting night under one date.

#### Caveats

The same turtle can emerge multiple times per night. E.g., a turtle
could emerge one or several times for an unsuccessful nesting attempt
before being processed after a successful one. Another turtle could
emerge one or several times and evade tagging altogether. In either
scenario, one turtle would contribute several emergences to a night's
tally. Therefore, the numbers presented here are an **optimistic
estimate** of total turtle numbers.

<!--  

TODO Verify - are missed tracks of pre-WAStD seasons entered in WAMTRAM? 

# Static (too long)
# total_turtles %>%
#   dplyr::filter(species == "natator-depressus") %>%
#   dplyr::select(-site_name, -species) %>%
#   janitor::clean_names(case="sentence") %>%
#   gt::gt(groupname_col=NULL, caption = "Total Flatback emergences") %>%
#   gt::tab_header(title="Total Flatback emergences", subtitle="")
-->
### Total emergences (processed and missed) turtles per season
The emergences are the sum of processed and missed turtles. 
The percentage of processed turtles is shown as the fraction of processed turtles
over total emergences (processed and missed).

All processed turtles but one historic sighting of a Leatherback turtle are tagged.
We therefore exclude the further split of processed turtles into tagged and non-tagged turtles.

Later in this report, we split the total emergences into nesting and non nesting.

This summary is exported as `total_turtles_season.csv`.

```{r total_turtles_season}
total_turtles_season %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Total number of turtles"
  ) %>% 
  # gt::fmt_date(c("First day", "Last day")) %>% # Friday, October 20, 2017
  gt::tab_header(
    title="Total numbers of turtles",
    subtitle="Turtle emergences grouped by season and species"
  ) %>% 
  gt::tab_spanner("Total Turtles", columns = c(Emergences)) %>% 
  gt::tab_spanner("Emergences", columns = c(Processed, Missed))
```

### Total, processed, and missed turtles per night
Data:

* All species.
* All seasons. Dedicated monitoring starts in season 2008-09.
* Processed turtles: WAMTRAM records indicating successful tagging
* Missed turtles: WAMTRAM records indicating tracks from a missed turtle, 
  the track being either encountered during night tagging or during a morning
  survey.

The tally of processed (tagged) and missed turtles is shown first as an interactive table
(tallied by season and date, respectively), then as a time series plots in the 
following sections.

We show an interactive table, as the printed version is too long.
This summary is exported as `total_turtles.csv`.

<!-- TODO save to CSV  -->
```{r total_turtles_date}
total_turtles %>% rt()
```


### Recent seasons split by species
* Data: combined emergences from WAMTRAM and WAStD, `total_turtles_season`
* Y: Absolute numbers of processed (=tagged) and missed turtles
* X: Year (from 2008)

This figure is exported as `turtles_proc_mis_by_species.png`.

<!-- TODO processed vs missed - change  total_turtles_season$tagged to exclude w2 non-tagged -->
<!-- TODO save to PNG  -->
```{r proc_vs_missed_fig, fig.height=12}
total_turtles_season %>%
  tidyr::pivot_longer(cols=c(Missed, Processed), names_to="Type", values_to="N") %>%
  dplyr::filter(Season > 2007) %>% # , species == "natator-depressus"
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x=Season, y=N, colour=Type, fill=Type)) +
  ggplot2::facet_grid(facets = ggplot2::vars(Species), scales="free_x") +
  ggplot2::ggtitle(label="Processed and missed turtles", 
                   subtitle="Numbers of processed and missed turtles over seasons by species") + 
  ggplot2::labs(x="Year", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL
```

### All species, all seasons

This figure is exported as `turtles_proc_mis_by_season.png`.

<!-- TODO save to PNG  -->
```{r total_turtles_date_fig, fig.height=12}
ggplot2::ggplot(
  data = total_turtles,
  mapping = ggplot2::aes(x = tdate_as_fdate(`Turtle date`))
) +
  ggplot2::geom_bar(ggplot2::aes(y = Missed),
                    stat = "identity",
                    color = "black",
                    fill = "black"
  ) +
    ggplot2::geom_bar(ggplot2::aes(y = Processed),
                    stat = "identity",
                    color = "grey",
                    fill = "grey"
  ) +
  ggplot2::facet_grid(facets = ggplot2::vars(Season), scales = "free_x") +
  ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
  ggplot2::ggtitle(label="Total turtle emergences", 
                   subtitle="Tagged vs missed by season") + 
  ggplot2::labs(x="Date", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL
```

```{r total_turtles_fb_date_fig, fig.height=12}
ggplot2::ggplot(
  data = total_turtles %>% dplyr::filter(Species == "Natator depressus"),
  mapping = ggplot2::aes(x = tdate_as_fdate(`Turtle date`))
) +
  ggplot2::geom_bar(ggplot2::aes(y = Missed),
                    stat = "identity",
                    color = "black",
                    fill = "black"
  ) +
    ggplot2::geom_bar(ggplot2::aes(y = Processed),
                    stat = "identity",
                    color = "grey",
                    fill = "grey"
  ) +
  ggplot2::facet_grid(facets = ggplot2::vars(Season), scales = "free_x") +
  ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
  ggplot2::ggtitle(label="Total Flatback turtle emergences", 
                   subtitle="Tagged vs missed by season") + 
  ggplot2::labs(x="Date", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL
```

## New, remigrant, recaptured turtles
WAMTRAM tagging records are grouped by season, species, and observation status
(initial nesting, remigrant, resighting, initial sighting) and tallied.

The only record of an "initial sighting" is a historic sighting of a Leatherback
turtle in 1995.

This summary is exported as `turtles_new_rem_rec.csv` and shown in tables 
below split by species.

<!-- TODO save to CSV  -->

<!-- TODO plots?  -->
```{r trt_mcr}
turtles_mcr <- w2 %>% 
  # dplyr::filter(species_code == "FB") %>% 
  dplyr::group_by(season, species, observation_status) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species) %>% 
  tidyr::pivot_wider(names_from = observation_status, values_from = n) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence") 
```

```{r trt_mcr_fb}
turtles_mcr %>% 
  dplyr::filter(Species == "Natator depressus") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season of Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season of Flatback turtles"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```

```{r trt_mcr_gn}
turtles_mcr %>% 
  dplyr::filter(Species == "Chelonia mydas") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season of Green turtles"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season of Green turtles"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```
```{r trt_mcr_hb}
turtles_mcr %>% 
  dplyr::filter(Species == "Eretmochelys imbricata") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season of Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season of Hawksbill turtles"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```



<!--
-   Add figure "remigration interval": show the number of remigrants
    coming back after 1,2,3, 4+ years
-   Add text about remigrant turtles coming from other rookeries
-->

## Morphometrics
Tagging data fields `w2$ccl` and `w2$ccw` are grouped by season and species, 
summarised into mean, sd, min, max, and rounded to two decimals.

These summary statistics of curved carapace length and width in mm are shown below.

<!-- TODO save to CSV  -->
<!-- TODO split by species?  -->

This summary is exported as `turtles_morph.csv` and shown below split by species.

```{r morph}
trt_morph <- w2 %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::summarise(
    ccl_mean = mean(ccl) %>% round(2),
    ccl_sd = sd(ccl) %>% round(2),
    ccl_min = min(ccl) %>% round(2),
    ccl_max = max(ccl) %>% round(2),
    ccw_mean = mean(ccw) %>% round(2),
    ccw_sd = sd(ccw) %>% round(2),
    ccw_min = min(ccw) %>% round(2),
    ccw_max = max(ccw) %>% round(2)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence")
```

```{r morph_fb}
trt_morph %>% 
  dplyr::filter(Species == "Natator depressus") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species: Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )
```
```{r morph_gn}
trt_morph %>% 
  dplyr::filter(Species == "Chelonia mydas") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species: Green turtles"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )
```

```{r morph_hb}
trt_morph %>% 
  dplyr::filter(Species == "Eretmochelys imbricata") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species: Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )
```

## Nesting success

We calculate the **nesting success** as the fraction of confirmed nests
(turtles observed laying during tagging plus "successful crawl" turtle
tracks with what is believed by the observer to be a nest) over the
total number of emergences.

As nesting success are counted:

* Tagging records with `nesting` "Y" (confirmed yes)
* Tracks with `nest_type` "successful-crawl", believed to be a nest by the observer

As unknowns are counted:

* Tagging records with `nesting` "U" (unsure of nesting) and "P" (unknown)
* Tracks with `nest_type` "track-not-assessed" (did not check for nest),
  and "track-unsure" (checked but unsure)
  
As non nesting are counted:

* Tagging records with `nesting` "N" (confirmed no)
* Tracks with `nest_type` "false-crawl", believed not to be a nest by the observer

#### Caveats

When calculating the nesting success as fraction of successful over total nesting, 
we lump all degrees of uncertainty about the nesting success into the
category of nesting failure. This includes the confirmed absence of a
nest ("false crawl"), but also cases where the presence of a nest is
unsure or not checked for. The value of nesting success is therefore a
**conservative estimate**. 

The data are biased (both ways) by the observers' individual ability to 
recognize a nest.

<!-- TODO spot check numbers - are non-nesting tallies missing?  -->
<!-- TODO save to CSV  -->

This summary is exported as `total_nesting_by_season_species.csv`.

```{r}
wastd_nesting_type_by_season_age_species <-
  x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  wastdr::nesting_type_by_area_season_species() %>% 
  dplyr::arrange(-season)

w2_nesting_type_by_season_species <- 
  w2 %>% 
  dplyr::group_by(season, species, nesting) %>% 
  dplyr::tally() %>%
  dplyr::ungroup() %>%
  tidyr::spread(nesting, n, fill = 0) %>% 
  dplyr::rename(nesting=Y, non_nesting=N, unknown_nesting=U, unsure_nesting=P)
  
total_nesting_by_season_species <-
  dplyr::full_join(
    wastd_nesting_type_by_season_age_species,
    w2_nesting_type_by_season_species,
    by=c("season", "species")
  ) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::transmute(
    season = season,
    species = stringr::str_to_sentence(species) %>% stringr::str_replace("-"," "),
    nesting = `successful-crawl` + nesting,
    unsure = `track-not-assessed` + `track-unsure` + unsure_nesting +  unknown_nesting,
    non_nesting = `false-crawl` + non_nesting,
    nesting_success = round(nesting * 100 / (nesting+unsure+non_nesting), 2)
  )

total_nesting_by_season_species %>%
  dplyr::filter(season>2016) %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Nesting by season and species tallied by nesting success from tagging and track data"
  ) %>% 
  gt::tab_header(
    title="Seasonal nesting totals",
    subtitle="Nesting by season and species tallied by nesting success"
  ) %>%
  gt::cols_label(
    season = "Season",
    species = "Species",
    nesting = "Nesting confirmed",
    unsure = "Nesting unsure",
    non_nesting = "Non nesting",
    nesting_success = "Nesting success"
  )
```

<!--  TODO Build this from  total_nesting_by_season_species 
show nesting success as fraction of confirmed yes over all nesting
-->
<!-- TODO save to PNG  -->
```{r nesting success_fb, eval=FALSE}
sp <- "natator-depressus"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
sp <- "chelonia-mydas"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
sp <- "eretmochelys-imbricata"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
```

## Hatching and emergence success
WAStD nest excavation data on clutch size, hatching and emergence success are 
grouped by season and species, then summarised into mean, sd, min, max, 
and rounded to two decimals.

<!-- SFO
add map showing locations of hatched nests throughout the season
add map showing location of excavated nests and their hatching success
Hatching success can be shown in categories
add histogram showing proportion of nests in each hatching success categories
-->

<!-- TODO save to CSV: explain wastd export  -->
<!-- TODO QA max clutch sizes  -->

Nest excavations are exported as `nest_excavations.csv`. One record therein
refers to one excavated nest.

```{r hatch_succ}
x$nest_excavations %>% 
  wastdr::hatching_emergence_success() %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Hatching and emergence success by season and species"
  ) %>% 
  gt::tab_header(
    title="Hatching and emergence success by season and species",
    subtitle="Values in percent, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Clutch size",
    columns = c(gt::contains("clutch"))
  ) %>% 
  gt::tab_spanner(
    label = "Hatching success",
    columns = c(gt::contains("hatching"))
  ) %>% 
  gt::tab_spanner(
    label = "Emergence success",
    columns = c(gt::contains("emergence"))
  )

```

## Sand temperatures

# Connectivity

## Connections to foraging grounds

## Tag recoveries

Tags from Delambre rookery found elsewhere (individual)
<!-- TODO James: how to get from W2 -->

## Satellite tracking

# Pressures and Threats

## Injuries of tagged turtles
<!-- TODO injuries  -->

## Predation and Disturbance
Predation and disturbance is recorded through WAStD as either general disturbance
and stand-alone signs of predator presence, or as disturbed or predated nests.

Each distinct cause of predation or disturbance is recorded separately.

### Disturbance and nest predation

<!-- TODO save to CSV: explain wastd export  -->
Nest and general disturbances are exported as `nest_dist.csv`. One record therein
refers to one distinct disturbance or predation of one nest, or one distinct
sign of general disturbance or predator presence.

```{r}
x$nest_dist %>% 
  wastdr::disturbance_by_season() %>% 
  dplyr::arrange(-season, encounter_type, -n) %>% 
  janitor::clean_names(case = "sentence") %>% 
  rt()
```

### General disturbance

```{r dist_map}
x$nest_dist %>% 
  dplyr::filter(encounter_encounter_type == "other") %>% 
  wastdr::map_dist()
```

### Disturbed nests

```{r dist_map_nest}
x$nest_dist %>% 
  dplyr::filter(encounter_encounter_type == "nest") %>% 
  wastdr::map_dist()
```
