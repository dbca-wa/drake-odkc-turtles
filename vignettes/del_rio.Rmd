---
title: 'Delambre Island  Flatback Turtle Monitoring Report - Appendix 1: Data'
author: "NWSFTCP, DBCA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_width: 10
    fig_height: 6
    code_folding: hide
    theme: lumen
  pdf_document:
    toc: yes
    toc_depth: '3'
vignette: |
  %\VignetteIndexEntry{wastd} %\VignetteEncoding{UTF-8} %\VignetteEngine{knitr::rmarkdown}
params:
  area_name: Delambre Island
  prefix: DEL
  w2_filepath: 'data/wamtram.csv'
  w2_observed_location_code: 'DA'
  w2_exported_on: '20 Sept 2021'
  export_dir: 'inst/reports/rio'
editor_options:
  markdown:
    wrap: 72
---

```{css, echo=FALSE}
body, .main-container {max-width: 100%; margin-left: auto; margin-right: auto;}
```

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
library(wastdr)
library(sparkline)
library(ggplot2)
library(gt)
library(reactable)

# -----------------------------------------------------------------------------#
# Helpers
# 
# Rendered tables: gt
# Interactive tables: reactable
rt <- . %>% 
  reactable::reactable(
    ., 
    filterable = T, 
    sortable = T, 
    searchable = T,
    defaultColDef = reactable::colDef(html = TRUE)
  )

# -----------------------------------------------------------------------------#
# Data export
# 
zipfn <- wastdr::urlize(params$area_name)
fn <- here::here(params$export_dir, zipfn)
if (!fs::file_exists(fn)) {
  "Creating dir {fn}" %>% glue::glue() %>% wastdr::wastdr_msg_info()
  fs::dir_create(fn, recurse = TRUE)
}

# Data labels
pn <- params$area_name
pf <- params$prefix
ld <- fn

# -----------------------------------------------------------------------------#
# WAStD data: load snapshot from ETL
# 
drake::loadd("wastd_data")

x <- wastd_data %>% 
  wastdr::filter_wastd_turtledata(area_name = params$area_name)

x %>% wastdr::export_wastd_turtledata(outdir = fn, filename = zipfn)

# -----------------------------------------------------------------------------#
# WAMTRAM data: load from manual export
# 
species_lookup <- tibble::tribble(
  ~ species_code, ~ species,
  "HK", "eretmochelys-imbricata",
  "FB", "natator-depressus",
  "LB", "dermochelys-coriacea", 
  "GN", "chelonia-mydas"
) 

#' Convert WAMTRAM `clutch_completed` values into `successful_nesting`
#' 
annotate_w2_nesting_success <- . %>% 
  dplyr::mutate(
    successful_nesting = 
      dplyr::case_when(
        clutch_completed == "Y" ~ "nesting",
        clutch_completed == "N" ~ "non_nesting",
        TRUE ~ "unknown_nesting" # "U", "P", "D", NA
      ))

w2_all <- here::here(params$w2_filepath) %>% 
  readr::read_csv() %>% 
  janitor::clean_names() %>% 
  dplyr::left_join(species_lookup, by="species_code") %>% 
  dplyr::filter(turtle_status != "E") %>%
  dplyr::mutate(
    o_time = observed_time %>% tidyr::replace_na("00:00:00") %>% as.character(),
    o_datetime = glue::glue("{observation_date} {o_time} +08:00"),
    encounter_datetime_utc = lubridate::parse_date_time(
      o_datetime, 
      orders = c("dmYHMSz", "dmYz"), 
      tz="UTC"
      ) %>% lubridate::with_tz("UTC")
  ) %>% 
  wastdr::add_dates(date_col = "encounter_datetime_utc", parse_date = FALSE) %>% 
  annotate_w2_nesting_success()

w2 <- w2_all %>% 
  dplyr::filter(observed_location_code == params$w2_observed_location_code)

w2 %>% 
  readr::write_csv(
    here::here(
      ld, 
      glue::glue("wamtram_{params$w2_observed_location_code}.csv")
    )
  )

# Verify that dates are correct:
# w2 %>% 
#   dplyr::select(
#     observation_date, 
#     observed_time, 
#     o_time,
#     datetime, # same as encounter_datetime_utc
#     encounter_datetime_utc, 
#     calendar_date_awst, 
#     turtle_date) %>% 
#   View()
#   
# R> w2$datetime[[1]]
# [1] "1987-11-25 05:18:00 UTC"
# R> w2$encounter_datetime_utc[[1]] %>% lubridate::with_tz("Australia/Perth")
# [1] "1987-11-25 13:18:00 AWST"

# cols(
#   TURTLE_ID = col_double(),
#   SPECIES_CODE = col_character(),
#   IDENTIFICATION_CONFIDENCE = col_character(),
#   SEX = col_logical(),
#   TURTLE_STATUS = col_character(),
#   OBSERVATION_ID = col_double(),
#   OBSERVATION_STATUS = col_character(),
#   TAG_1 = col_character(),
#   TAG_2 = col_character(),
#   TAG_3 = col_character(),
#   TAG_4 = col_character(),
#   PIT_TAGS = col_character(),
#   OTHER_IDENTIFICATION = col_character(),
#   LOCATION_CODE = col_character(),
#   OBSERVATION_DATE = col_character(),
#   OBSERVED_TIME = col_time(format = ""),
#   OBSERVED_LOCATION_CODE = col_character(),
#   PLACE_CODE = col_character(),
#   ACTIVITY_CODE = col_character(),
#   BEACH_POSITION_CODE = col_character(),
#   NESTING = col_character(),
#   CLUTCH_COMPLETED = col_character(),
#   NUMBER_OF_EGGS = col_double(),
#   EGG_COUNT_METHOD = col_character(),
#   COMMENTS = col_character(),
#   CCL = col_double(),
#   CCW = col_double(),
#   DATUM_CODE = col_character(),
#   LATITUDE = col_double(),
#   LONGITUDE = col_double(),
#   LATITUDE_DEGREES = col_logical(),
#   LATITUDE_MINUTES = col_logical(),
#   LATITUDE_SECONDS = col_logical(),
#   LONGITUDE_DEGREES = col_logical(),
#   LONGITUDE_MINUTES = col_logical(),
#   LONGITUDE_SECONDS = col_logical(),
#   ZONE = col_double(),
#   EASTING = col_double(),
#   NORTHING = col_double(),
#   DAMAGE = col_character()
# )

# -----------------------------------------------------------------------------#
# Emergences: WAStD
# 
# Missed turtles during tagging
# We don't filter by track_age
# This includes "missed just now" from tagging, 
# "fresh" and "old" from morning track count.
wastd_missed_turtles <- 
  x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  dplyr::filter(
    nest_type %in% c(
      "successful-crawl", 
      "false-crawl", 
      "track-unsure", 
      "track-not-assessed")
  ) %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "missed") %>% 
  dplyr::ungroup() 
 
# B from night tagging
# unique(w2$turtle_status) "T" "Q" "N" "P" "A" "R" 
# processed: "T" "Q" "P" "A" "R" - missed: "N" NA
# new tag applied:
# "A" new tag
# "P" query new tagged - new on a turtle with tag scars and no PIT = not a new turtle
# "Q" query identity - a record flagged for curation, can become R or A
# "T" tagged
# "R" re-entered population - a curated record, was Q
#  
# no new tag applied:
# "N" non tagged
# NA  
# C captive
# E error data not to be used
# s salvage

# -----------------------------------------------------------------------------#
# Emergences: processed + missed
# w2_processed_turtles = w2_tagged_turtles + w2_non_tagged_turtles
w2_processed_turtles <- w2 %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "processed") %>% 
  dplyr::ungroup()

w2_tagged_turtles <- w2 %>% 
  dplyr::filter(turtle_status %in% c("A", "P", "Q", "T", "R")) %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "tagged") %>% 
  dplyr::ungroup()

w2_non_tagged_turtles <- w2 %>% 
  dplyr::filter(turtle_status %in% c("N", NA, "C", "S")) %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "non_tagged") %>% 
  dplyr::ungroup()

# Total emergences = missed (WAStD) + processed (w2)
total_turtles <- dplyr::full_join(
  wastd_missed_turtles,
  w2_processed_turtles,
  by=c("species", "season", "turtle_date")
) %>% 
  dplyr::mutate(
    emergences = processed + missed,
    processed_pct = round(processed * 100 / (emergences), 2)
  ) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  dplyr::select(season, turtle_date, species, emergences, processed, missed, processed_pct) %>% 
  janitor::clean_names(case="sentence")

# Season x species tally of wastd_missed_turtles
missed_turtles_season_totals <- wastd_missed_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "missed", wt = missed) %>% 
  dplyr::ungroup() 

# Season x species tally of w2_processed_turtles
processed_turtles_season_totals <- w2_processed_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "processed", wt = processed) %>% 
  dplyr::ungroup() 

# Season x species tally of w2_tagged_turtles
tagged_turtles_season_totals <- w2_tagged_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "tagged", wt = tagged) %>% 
  dplyr::ungroup() 

# Season x species tally of w2_non_tagged_turtles
non_tagged_turtles_season_totals <- w2_non_tagged_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "non_tagged", wt = non_tagged) %>% 
  dplyr::ungroup() 

# Total turtles
total_turtles_season <- 
  missed_turtles_season_totals %>% 
  dplyr::full_join(processed_turtles_season_totals, by=c("species", "season")) %>% 
  # we skip tagged/non tagged as there is only one non tagged (historic sighting)
  # dplyr::full_join(tagged_turtles_season_totals, by=c("species", "season")) %>% 
  # dplyr::full_join(non_tagged_turtles_season_totals, by=c("species", "season")) %>% 
  dplyr::mutate(
    emergences = processed+missed,
    processed_pct = round(processed * 100 / (emergences), 2)) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  dplyr::select(season, species, emergences, processed, missed, processed_pct) %>% 
  janitor::clean_names(case="sentence")

total_turtles_season %>% 
  readr::write_csv(here::here(ld, "total_turtles_season.csv"))

# -----------------------------------------------------------------------------#
# Nesting success
# 
# 
# We equate clutch_completed with successful nesting.
# w2$clutch_completed %>% unique()
# Y yes, N no, P possible, U uncertain, D did not check
# 
# Nesting success by season and species: season summary (tracks)
wastd_nesting_type_by_season_age_species <-
  x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  wastdr::nesting_type_by_area_season_species() %>% 
  dplyr::arrange(-season)

# Nesting success by season and species: season summary (tagging)
w2_nesting_type_by_season_species <- 
  w2 %>% 
  dplyr::group_by(season, species, successful_nesting) %>% 
  dplyr::tally() %>%
  dplyr::ungroup() %>%
  tidyr::spread(successful_nesting, n, fill = 0)

# Nesting success by season and individual turtle: internesting and clutch freq
w2_nesting_type_by_season_turtle <- 
  w2 %>% 
  dplyr::group_by(season, species, turtle_id, successful_nesting) %>% 
  dplyr::tally() %>%
  dplyr::ungroup() %>%
  tidyr::spread(successful_nesting, n, fill = 0) %>% 
  dplyr::arrange(-season, turtle_id, -nesting)
  
total_nesting_by_season_species <-
  dplyr::full_join(
    wastd_nesting_type_by_season_age_species,
    w2_nesting_type_by_season_species,
    by=c("season", "species")
  ) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::transmute(
    season = season,
    species = stringr::str_to_sentence(species) %>% stringr::str_replace("-"," "),
    nesting = `successful-crawl` + nesting,
    unsure = `track-not-assessed` + `track-unsure` + unknown_nesting,
    non_nesting = `false-crawl` + non_nesting,
    nesting_success = round(nesting * 100 / (nesting+unsure+non_nesting), 2)
  )

total_nesting_by_season_species %>% 
  readr::write_csv(here::here(ld, "total_nesting_by_season_species.csv"))

w2_nesting_type_by_season_turtle %>% 
  readr::write_csv(here::here(ld, "total_nesting_by_season_turtle.csv"))

# -----------------------------------------------------------------------------#
# Connectivity
trt_conn <- 
  w2_all %>% 
  dplyr::group_by(season, species, observed_location_code, location_code) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  tidyr::pivot_wider(
    names_from=location_code, 
    names_sort = TRUE, 
    values_from=n,
    values_fill = 0
  ) %>% 
  dplyr::arrange(-season, observed_location_code, species)

trt_conn %>% 
  readr::write_csv(here::here(ld, "turtle_nesting_connectivity.csv"))


# -----------------------------------------------------------------------------#
# Damages and injuries
damage_codes <- tibble::tribble(
  ~"damage_type", ~"damage",
  "0", "None significant",
  "1", "Tip off - Flipper",
  "2", "Lost from Nail - Flipper",
  "3", "Lost half - Flipper",
  "4", "Lost whole - Flipper",
  "5", "Minor Wounds or cuts",
  "6", "Major Wounds or cuts",
  "7", "Deformity"
)

# w2$damage split by comma, tally unique injuries
# 
trt_numbers <- w2 %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "total_turtles") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  )
  
trt_dmg <- w2 %>% 
  dplyr::select(season, turtle_date, species, damage) %>% 
  tidyr::separate_rows(damage, sep = ", ") %>% 
  tidyr::drop_na(damage) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," "),
    damage = damage %>% 
      stringr::str_replace("mid-carapace", "mid carapace") %>%
      stringr::str_replace(" - entire", " entire") %>% 
      trimws()
  ) %>% 
  tidyr::separate(damage, c("body_part", "damage_type"), sep = " - ") %>% 
  dplyr::left_join(damage_codes, by = c("damage_type")) %>% 
  dplyr::select(-damage_type) %>% 
  dplyr::arrange(-season) %>% 
  dplyr::left_join(trt_numbers, by=c("season", "species"))

trt_dmg %>% 
  readr::write_csv(here::here(ld, "trt_dmg.csv"))


trt_dmg_by_species_season <- trt_dmg %>% 
  dplyr::group_by(season, species, damage, total_turtles) %>% 
  dplyr::tally(name = "damaged_turtles") %>% 
  dplyr::mutate(damage_pct = round(100* damaged_turtles / total_turtles, 2)) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(species, -season, -damage_pct) %>% 
  janitor::clean_names(case="sentence")

trt_dmg_by_species_season %>% 
  readr::write_csv(here::here(ld, "trt_dmg_by_species_season.csv"))

trt_dmg_type_pivot <- trt_dmg %>% 
  dplyr::group_by(season, species, damage, total_turtles) %>% 
  dplyr::tally(name = "damaged_turtles") %>% 
  dplyr::mutate(damage_pct = round(100* damaged_turtles / total_turtles, 2)) %>% 
  dplyr::ungroup() %>% 
  janitor::clean_names(case="sentence") %>% 
  tidyr::pivot_wider(
    names_from = Season, 
    values_from = `Damage pct`, 
    names_sort = TRUE, 
    values_fill = 0
  ) %>% 
  dplyr::select(-`Total turtles`, -`Damaged turtles`) 

trt_dmg_type_pivot %>% 
  readr::write_csv(here::here(ld, "trt_dmg_type_pivot.csv"))

trt_dmg_bodypart_pivot <- trt_dmg %>% 
  dplyr::group_by(season, species, body_part, total_turtles) %>% 
  dplyr::tally(name = "damaged_turtles") %>% 
  dplyr::mutate(damage_pct = round(100* damaged_turtles / total_turtles, 2)) %>% 
  dplyr::ungroup() %>% 
  janitor::clean_names(case="sentence") %>% 
  tidyr::pivot_wider(
    names_from = Season, values_from = `Damage pct`, names_sort = TRUE, values_fill = 0
  ) %>% 
  dplyr::select(-`Total turtles`, -`Damaged turtles`) 

trt_dmg_bodypart_pivot %>% 
  readr::write_csv(here::here(ld, "trt_dmg_bodypart_pivot.csv"))
```


# Data

In this report, we present combined Turtle Monitoring data from WAStD
(Turtle Nesting Census, "tracks") and the tagging database WAMTRAM2
(Turtle Tagging, "tagging") and filter the data to the location
`r params$area_name`.

The WAStD data was downloaded on `r wastd_data$downloaded_on` and
reflects all QA operations on WAStD data up to this date.

The WAMTRAM2 data was exported on `r params$w2_exported_on` and
reflects all QA operations on WAMTRAM2 tagging data up to this date.

# Survey effort
Survey effort as shown here is calculated from surveys captured in WAStD.
Test and training surveys are excluded.`

The season length spans the dates of the first to the last survey of the season.

The estimate of hours spent surveying is inflated in past seasons (2019 and earlier)
by incorrectly merged surveys which span either two night tagging shifts, or
a night tagging shift and a morning track count. The estimate of hours will be
more accurate after these merged surveys have been un-merged.

On days of night tagging and morning track counts there should be two surveys 
per date.

In the 2020-21 season, monitoring effort was disrupted by thunderstorms and 
cyclone activity in weeks 3 and 4. On 2020-12-09, the field team was evacuated 
from Delambre Island.

```{r survey_effort}
x$surveys %>% 
  wastdr::filter_realsurveys() %>% 
  wastdr::survey_season_stats()  %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Seasonal overview of survey effort"
  ) %>% 
  # gt::fmt_date(c("First day", "Last day")) %>% # Friday, October 20, 2017
  gt::tab_header(
    title="Seasonal overview of survey effort",
    subtitle="Survey stats grouped by rookery and season"
  )
```

The following figure is saved as `DEL_survey_count_delambre-island.png`.

```{r svy_plt_count}
x$surveys %>% 
  wastdr::filter_realsurveys() %>% 
  plot_survey_count(local_dir = fn, placename = pn, prefix = pf, export = TRUE)
```
The following figure is saved as `DEL_survey_effort_delambre-island.png`.

```{r svy_plt_hrs}
x$surveys %>% 
  wastdr::filter_realsurveys() %>% 
  plot_survey_effort(local_dir = ld, placename = pn, prefix = pf, export = TRUE)
```

<!--
# List individual surveys with links to WAStD
# x$surveys %>% survey_show_detail() %>% rt

# Survey effort: numbers
# x$surveys %>% surveys_per_site_name_and_date() %>% rt
# x$surveys %>% list_survey_count()
# x$surveys %>% survey_hours_per_site_name_and_date() %>% rt
# x$surveys %>% list_survey_effort()
# x$surveys %>% survey_hours_per_person() %>% rt
# Heatmaps break on calendar years
# x$surveys %>% survey_count_heatmap(placename = pn, prefix = pf, export = FALSE)
# x$surveys %>% survey_hours_heatmap(placename = pn, prefix = pf, export = FALSE)
-->

# Nesting

## Season overview
Nesting census data (WAStD tracks) are shown for the last season (2020-21). 
Training records are excluded.

<!-- 
TODO: show tagging in tracks_map_2020, save static map
-->

```{r tracks_map_2020}
x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  wastdr::filter_wastd_season(2020) %>% 
  wastdr::map_tracks(sites = x$sites, cluster = FALSE)
```

## Turtle emergences and processing success
We calculate the **total number of turtle emergences per night** as the sum of
emergences from the following observations:

-   nesting females tagged at night (from WAMTRAM tagging - all records are a 
    processed turtle, nesting or not, tagged or not)
-   tracks of turtles missed during tagging (from WAStD tracks of any 
    nesting success type - success, unsure, or no success,
    with track age "missed just now")
-   tracks of turtles missed during tagging and then encountered during a
    nesting census beach walk the next morning (from WAStD tracks,
    tracks of of any nesting success type with track age 
    "new, made in past 24 hours")

We exclude hatched nests, incubating nests without a track (each are older than a
day), and body pits (which can be recorded, but are of little value).

We assume each record in WAMTRAM is a turtle emergence, be it tagged or not, and
nesting or not. We assume no record in WAMTRAM is duplicated in WAStD, i.e.
turtles are either captured on paper (WAMTRAM) or in a tablet (WAStD), but never
on both media.

We bin the numbers for tallying by the "turtle date", which is the
calendar date of the tagging night and extends to encounters past
midnight and on the next morning. 
Turtle date rolls over at noon and lags behind calendar date by 12 hours. 
Turtle date bins all recorded events from one nesting night under one date.

#### Caveats
The same turtle can emerge multiple times per night. E.g., a turtle
could emerge one or several times for an unsuccessful nesting attempt
before being processed after a successful one. Another turtle could
emerge one or several times and evade tagging altogether. In either
scenario, one turtle would contribute several emergences to a night's
tally. Therefore, the numbers presented here are an **optimistic
estimate** of total turtle numbers.

### Total emergences (processed and missed) turtles per season
The emergences are the sum of processed and missed turtles. 
The percentage of processed turtles is shown as the fraction of processed turtles
over total emergences (processed and missed).

All processed turtles but one historic sighting of a Leatherback turtle are tagged.
We therefore exclude the further split of processed turtles into tagged and non-tagged turtles.

Later in this report, we split the total emergences into nesting and non nesting.

This summary is exported as `total_turtles_season.csv`.

The low numbers in the 2020-21 season can be explained with thunderstorms and 
cyclone activity in weeks 3 and 4 of the 4 week turtle monitoring expedition.

```{r total_turtles_season}
total_turtles_season %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Total number of turtles"
  ) %>% 
  # gt::fmt_date(c("First day", "Last day")) %>% # Friday, October 20, 2017
  gt::tab_header(
    title="Total numbers of turtles",
    subtitle="Turtle emergences grouped by season and species"
  ) %>% 
  gt::tab_spanner("Total Turtles", columns = c(Emergences)) %>% 
  gt::tab_spanner("Emergences", columns = c(Processed, Missed))
```

### Total, processed, and missed turtles per night
Data:

* All species.
* All seasons. Dedicated monitoring starts in season 2008-09.
* Processed turtles: WAMTRAM records indicating successful tagging
* Missed turtles: WAMTRAM records indicating tracks from a missed turtle, 
  the track being either encountered during night tagging or during a morning
  survey.

The tally of processed (tagged) and missed turtles is shown first as an interactive table
(tallied by season and date, respectively), then as a time series plots in the 
following sections.

We show an interactive table, as the printed version is too long.
This summary is exported as `total_turtles.csv`.

```{r total_turtles_date}
total_turtles %>% rt()
```


### Recent seasons split by species
* Data: combined emergences from WAMTRAM and WAStD, `total_turtles_season.csv`
* Y: Absolute numbers of processed (=tagged) and missed turtles
* X: Year (from 2008)

This figure is exported as `turtles_proc_mis_by_species.png`.

```{r proc_vs_missed_fig, fig.height=12}
plt_total_turtles_season <- 
  total_turtles_season %>%
  tidyr::pivot_longer(cols=c(Missed, Processed), names_to="Type", values_to="N") %>%
  dplyr::filter(Season > 2007) %>% # , species == "natator-depressus"
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x=Season, y=N, colour=Type, fill=Type)) +
  ggplot2::facet_grid(facets = ggplot2::vars(Species), scales="free_x") +
  ggplot2::ggtitle(label="Processed and missed turtles", 
                   subtitle="Numbers of processed and missed turtles over seasons by species") + 
  ggplot2::labs(x="Year", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL

ggplot2::ggsave(
  plot = plt_total_turtles_season,
  filename = "turtles_proc_mis_by_species.png",
  path = fn,
  width = 10,
  height = 8
)

plt_total_turtles_season
```

### All species, all seasons

This figure is exported as `turtles_proc_mis_by_season.png`.

```{r total_turtles_date_fig, fig.height=12}
turtles_proc_mis_by_season <- 
  ggplot2::ggplot(
  data = total_turtles,
  mapping = ggplot2::aes(x = tdate_as_fdate(`Turtle date`))
) +
  ggplot2::geom_bar(ggplot2::aes(y = Missed),
                    stat = "identity",
                    color = "black",
                    fill = "black"
  ) +
    ggplot2::geom_bar(ggplot2::aes(y = Processed),
                    stat = "identity",
                    color = "grey",
                    fill = "grey"
  ) +
  ggplot2::facet_grid(facets = ggplot2::vars(Season), scales = "free_x") +
  ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
  ggplot2::ggtitle(label="Total turtle emergences", 
                   subtitle="Tagged vs missed by season") + 
  ggplot2::labs(x="Date", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL

ggplot2::ggsave(
  plot = turtles_proc_mis_by_season,
  filename = "turtles_proc_mis_by_season.png",
  path = fn,
  width = 10,
  height = 12
)

turtles_proc_mis_by_season
```

```{r total_turtles_fb_date_fig, fig.height=12}
ggplot2::ggplot(
  data = total_turtles %>% dplyr::filter(Species == "Natator depressus"),
  mapping = ggplot2::aes(x = tdate_as_fdate(`Turtle date`))
) +
  ggplot2::geom_bar(ggplot2::aes(y = Missed),
                    stat = "identity",
                    color = "black",
                    fill = "black"
  ) +
    ggplot2::geom_bar(ggplot2::aes(y = Processed),
                    stat = "identity",
                    color = "grey",
                    fill = "grey"
  ) +
  ggplot2::facet_grid(facets = ggplot2::vars(Season), scales = "free_x") +
  ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
  ggplot2::ggtitle(label="Total Flatback turtle emergences", 
                   subtitle="Tagged vs missed by season") + 
  ggplot2::labs(x="Date", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL
```

## New, remigrant, recaptured turtles
<!--
Per species:

Season
New tagged
ISR# inter season returns (turtle recaptured from previous season)
Total individuals
Total processed
Missed turtles
Total turtles recorded
Mean nightly turtles
-->

WAMTRAM tagging records are grouped by season, species, and observation status
(initial nesting, remigrant, resighting, initial sighting) and tallied.

The only record of an "initial sighting" is a historic sighting of a Leatherback
turtle in 1995.

This summary is exported as `turtles_new_rem_rec.csv` and shown in tables 
below split by species.

```{r trt_mcr}
turtles_mcr <- w2 %>% 
  # dplyr::filter(species_code == "FB") %>% 
  dplyr::group_by(season, species, observation_status) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species) %>% 
  tidyr::pivot_wider(names_from = observation_status, values_from = n) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence") 
```

```{r trt_mcr_fb}
turtles_mcr %>% 
  dplyr::filter(Species == "Natator depressus") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season of Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season of Flatback turtles"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```


```{r trt_mcr_hb}
turtles_mcr %>% 
  dplyr::filter(Species == "Eretmochelys imbricata") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season of Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season of Hawksbill turtles"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```

```{r trt_mcr_gn}
turtles_mcr %>% 
  dplyr::filter(Species == "Chelonia mydas") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season of Green turtles"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season of Green turtles"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```
<!--
-   Add figure "remigration interval": show the number of remigrants
    coming back after 1,2,3, 4+ years
-   Add text about remigrant turtles coming from other rookeries
-->

## Inter-nesting interval
The recorded nesting success of identified turtles is exported as 
`total_nesting_by_season_turtle.csv`.

We show summary statistics per season split by species in the following three
tables.

```{r internesting}
trt_internesting <- 
  w2_nesting_type_by_season_turtle %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::summarise(
    n = dplyr::n(),
    
    nesting_mean = mean(nesting) %>% round(2),
    nesting_sd = sd(nesting) %>% round(2),
    nesting_max = max(nesting),
    nesting_min = min(nesting),
    
    non_nesting_mean = mean(non_nesting) %>% round(2),
    non_nesting_sd = sd(non_nesting) %>% round(2),
    non_nesting_max = max(non_nesting),
    non_nesting_min = min(non_nesting),
    
    unknown_nesting_mean = mean(unknown_nesting) %>% round(2),
    unknown_nesting_sd = sd(unknown_nesting) %>% round(2),
    unknown_nesting_max = max(unknown_nesting),
    unknown_nesting_min = min(unknown_nesting)
    ) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species)
```

```{r intern_fb}
trt_internesting %>% 
  dplyr::filter(species == "natator-depressus") %>% 
  dplyr::select(-species) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Internesting by season of Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Internesting by season of Flatback turtles",
    subtitle="Counts of successful, unsuccessful, and unknown clutches per season"
  ) %>% 
  gt::tab_spanner(
    "Successful nesting", 
    columns = dplyr::contains("Nesting", ignore.case = FALSE)
  ) %>% 
  gt::tab_spanner(
    "Unsucessful nesting", 
    columns = dplyr::contains("Non nesting", ignore.case = FALSE)
  ) %>%  
  gt::tab_spanner(
    "Unknown nesting", 
    columns = dplyr::contains("Unknown nesting", ignore.case = FALSE)
  )
```



```{r intern_hb}
trt_internesting %>% 
  dplyr::filter(species == "eretmochelys-imbricata") %>% 
  dplyr::select(-species) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Internesting by season of Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Internesting by season of Hawksbill turtles",
    subtitle="Counts of successful, unsuccessful, and unknown clutches per season"
  ) %>% 
  gt::tab_spanner(
    "Successful nesting", 
    columns = dplyr::contains("Nesting", ignore.case = FALSE)
  ) %>% 
  gt::tab_spanner(
    "Unsucessful nesting", 
    columns = dplyr::contains("Non nesting", ignore.case = FALSE)
  ) %>%  
  gt::tab_spanner(
    "Unknown nesting", 
    columns = dplyr::contains("Unknown nesting", ignore.case = FALSE)
  )
```

```{r intern_gn}
trt_internesting %>% 
  dplyr::filter(species == "chelonia-mydas") %>% 
  dplyr::select(-species) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Internesting by season of Green turtles"
  ) %>% 
  gt::tab_header(
    title="Internesting by season of Green turtles",
    subtitle="Counts of successful, unsuccessful, and unknown clutches per season"
  ) %>% 
  gt::tab_spanner(
    "Successful nesting", 
    columns = dplyr::contains("Nesting", ignore.case = FALSE)
  ) %>% 
  gt::tab_spanner(
    "Unsucessful nesting", 
    columns = dplyr::contains("Non nesting", ignore.case = FALSE)
  ) %>%  
  gt::tab_spanner(
    "Unknown nesting", 
    columns = dplyr::contains("Unknown nesting", ignore.case = FALSE)
  )
```

## Clutch frequency
The clutch frequency is calculated from the individual turtles' nesting 
frequencies (`w2_nesting_type_by_season_turtle`) as a tally of the frequency of the 
confirmed successful nesting events. 
This summary ignores unsuccessful and unknown nesting events.

We show the clutch frequencies per season split by species in the following three
tables.

```{r clutch_freq}
clutch_freq <- 
  w2_nesting_type_by_season_turtle %>% 
  dplyr::group_by(season, species, nesting) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species, -nesting) %>%
  dplyr::rename(confirmed_clutches=nesting, Season=season) %>% 
  tidyr::pivot_wider(
    names_from=confirmed_clutches, values_from=n, names_sort=TRUE
  )
```

```{r clutch_freq_fb}
clutch_freq %>% 
  dplyr::filter(species == "natator-depressus") %>% 
  dplyr::select(-species) %>% 
  # janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Clutch frequency of Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Clutch frequency of Flatback turtles"
    # subtitle=""
  ) %>% 
  gt::tab_spanner(
    "Number of successful clutches", 
    columns = !dplyr::contains("Season")
  )
  
```


```{r clutch_freq_hb}
clutch_freq %>% 
  dplyr::filter(species == "eretmochelys-imbricata") %>% 
  dplyr::select(-species) %>% 
  # janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Clutch frequency of Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Clutch frequency of Hawksbill turtles"
    # subtitle=""
  ) %>% 
  gt::tab_spanner(
    "Number of successful clutches", 
    columns = !dplyr::contains("Season")
  )
  
```


```{r clutch_freq_gn}
clutch_freq %>% 
  dplyr::filter(species == "chelonia-mydas") %>% 
  dplyr::select(-species) %>% 
  # janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Clutch frequency of Green turtles"
  ) %>% 
  gt::tab_header(
    title="Clutch frequency of Green turtles"
    # subtitle=""
  ) %>% 
  gt::tab_spanner(
    "Number of successful clutches", 
    columns = !dplyr::contains("Season")
  )
  
```

## Morphometrics
Tagging data fields `w2$ccl` and `w2$ccw` are grouped by season and species, 
summarised into mean, sd, min, max, and rounded to two decimals.

These summary statistics of curved carapace length and width in mm are shown below.

This summary as a whole is exported as `trt_morph.csv` but shown below 
split by species.

```{r morph}
trt_morph <- w2 %>% 
  dplyr::filter(!is.na(ccl), !is.na(ccw)) %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::summarise(
    n = dplyr::n(),
    ccl_mean = mean(ccl) %>% round(2),
    ccl_sd = sd(ccl) %>% round(2),
    ccl_min = min(ccl) %>% round(2),
    ccl_max = max(ccl) %>% round(2),
    ccw_mean = mean(ccw) %>% round(2),
    ccw_sd = sd(ccw) %>% round(2),
    ccw_min = min(ccw) %>% round(2),
    ccw_max = max(ccw) %>% round(2),
    .groups = "keep"
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence")
```

```{r morph_fb}
trt_morph %>%
  dplyr::filter(Species == "Natator depressus") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species: Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species: Flatback turtles",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Group",
    columns = c(Season, Species, N)
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )
```

```{r morph_hb}
trt_morph %>% 
  dplyr::filter(Species == "Eretmochelys imbricata") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species: Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species: Hawksbill turtles",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Group",
    columns = c(Season, Species, N)
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )
```

```{r morph_gn}
trt_morph %>% 
  dplyr::filter(Species == "Chelonia mydas") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species: Green turtles"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species: Green turtles",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Group",
    columns = c(Season, Species, N)
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )
```

## Nesting success

We calculate the **nesting success** as the fraction of confirmed nests
(turtles observed laying during tagging plus "successful crawl" turtle
tracks with what is believed by the observer to be a nest) over the
total number of nesting attempts (emergences).

As nesting success are counted:

* Tagging records with `clutch_completed` status 

  * "Y" (confirmed completed clutch).
  
* Tracks with `nest_type` 

  * "successful-crawl" (believed to be a nest by the observer).

As unknowns are counted:

* Tagging records with `clutch_completed` status 

  * "P" (possible clutch, but not certain enough to confirm), 
  * "U" (uncertain about clutch), and 
  * "D" (did not check).
  
* Tracks with `nest_type` 

  * "track-not-assessed" (did not check for nest), and 
  * "track-unsure" (checked but unsure).
  
As non nesting are counted:

* Tagging records with `clutch_completed` status

  * "N" (confirmed no).
  
* Tracks with `nest_type` 
  
  * "false-crawl" (believed not to be a nest by the observer).

#### Caveats

When calculating the nesting success as fraction of successful over total nesting, 
we lump all degrees of uncertainty about the nesting success into the
category of nesting failure. This includes the confirmed absence of a
nest ("false crawl"), but also cases where the presence of a nest is
unsure or not checked for. 

Similarly, the tagging records cater for a range of unknowns, which again could
well be successfully completed clutches.

The **data** are biased (both ways) by the observers' individual ability to 
recognize a nest, and the opportunity to observe the clutch up to its successful 
end.

The **calculation** of nesting success lumps unknowns with negatives and therefore 
presents a **conservative estimate**. 

If we were to include unknowns (or a realistic fraction thereof) with successful 
nesting, we would get an **optimistic estimate**.

Nesting success measured during night tagging can be assumed to be lowered by
the disruption through monitoring disturbance.

<!--
* Nesting success (optimistic) = yes + unsure / yes + unsure + no
* Nesting success is lower during tagging because tagging disrupts nesting
* Morning surveys of tracks with/without nests don't disturb nesting process, but
  biased by observer capability to determine nest presence (barring excavation).
-->

This summary is exported as `total_nesting_by_season_species.csv`.

```{r nesting_totals}
total_nesting_by_season_species %>%
  dplyr::filter(season>2016) %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Nesting by season and species tallied by nesting success from tagging and track data"
  ) %>% 
  gt::tab_header(
    title="Seasonal nesting totals",
    subtitle="Nesting by season and species tallied by nesting success"
  ) %>%
  gt::cols_label(
    season = "Season",
    species = "Species",
    nesting = "Nesting confirmed",
    unsure = "Nesting unsure",
    non_nesting = "Non nesting",
    nesting_success = "Nesting success"
  )
```

<!--  
TODO Build this from  total_nesting_by_season_species 
show nesting success as fraction of confirmed yes over all nesting
-->
<!-- TODO save to PNG  -->
```{r nesting success_fb, eval=FALSE}
sp <- "natator-depressus"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
sp <- "chelonia-mydas"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
sp <- "eretmochelys-imbricata"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
```

## Hatching and emergence success
WAStD nest excavation data on clutch size, hatching and emergence success are 
grouped by season and species, then summarised into mean, sd, min, max, 
and rounded to two decimals.

<!-- SFO
add map showing locations of hatched nests throughout the season
add map showing location of excavated nests and their hatching success
Hatching success can be shown in categories
add histogram showing proportion of nests in each hatching success categories
-->

Nest excavations are exported as `nest_excavations.csv`. One record therein
refers to one excavated nest.

```{r hatch_succ}
x$nest_excavations %>% 
  wastdr::hatching_emergence_success() %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Hatching and emergence success by season and species"
  ) %>% 
  gt::tab_header(
    title="Hatching and emergence success by season and species",
    subtitle="Values in percent, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Clutch size",
    columns = c(gt::contains("clutch"))
  ) %>% 
  gt::tab_spanner(
    label = "Hatching success",
    columns = c(gt::contains("hatching"))
  ) %>% 
  gt::tab_spanner(
    label = "Emergence success",
    columns = c(gt::contains("emergence"))
  )

```

<!--  ## Sand temperatures - no data -->

# Connectivity

This section shows a confusion matrix of turtle numbers between places they 
were observed. These places include rookeries and foraging grounds.

As origin ("Initially observed at") we consider the place where a
previously unmarked turtle was tagged for the first time. In the original data,
this is coded as column `location_code`.

As destination ("Observed at") we consider the place a turtle was observed.
In the original data, this is coded as column `observed_location_code`.

The data is saved as `turtle_nesting_connectivity.csv`.

```{r trt_conn_fb}
trt_conn %>% 
  dplyr::filter(species == "natator-depressus") %>%
  gt::gt(
    groupname_col=NULL,
    caption = "Connectivity of Flatback turtles"
  ) %>% 
  gt::tab_header(
    title="Connectivity of Flatback turtles"
  ) %>% 
  gt::cols_label(
    season = "Season",
    species = "Species",
    observed_location_code = "Observed at"
  ) %>% 
  gt::tab_spanner(
    label = "Initially observed at",
    columns = c(
      -gt::contains("season"), 
      -gt::contains("species"), 
      -gt::contains("observed_location_code")
    )
  ) 
```


```{r trt_conn_hb}
trt_conn %>% 
  dplyr::filter(species == "eretmochelys-imbricata") %>%
  gt::gt(
    groupname_col=NULL,
    caption = "Connectivity of Hawksbill turtles"
  ) %>% 
  gt::tab_header(
    title="Connectivity of Hawksbill turtles"
  ) %>% 
  gt::cols_label(
    season = "Season",
    species = "Species",
    observed_location_code = "Observed at"
  ) %>% 
  gt::tab_spanner(
    label = "Initially observed at",
    columns = c(
      -gt::contains("season"), 
      -gt::contains("species"), 
      -gt::contains("observed_location_code")
    )
  ) 
```


```{r trt_conn_gn}
trt_conn %>% 
  dplyr::filter(species == "chelonia-mydas") %>%
  gt::gt(
    groupname_col=NULL,
    caption = "Connectivity of Green turtles"
  ) %>% 
  gt::tab_header(
    title="Connectivity of Green turtles"
  ) %>% 
  gt::cols_label(
    season = "Season",
    species = "Species",
    observed_location_code = "Observed at"
  ) %>% 
  gt::tab_spanner(
    label = "Initially observed at",
    columns = c(
      -gt::contains("season"), 
      -gt::contains("species"), 
      -gt::contains("observed_location_code")
    )
  ) 
```

<!-- 
## Tag recoveries
Life history of individual turtles sighted in-water at RBB

-->

# Pressures and Threats

## Injuries of tagged turtles
Injuries are reported as part of the tagging process.
The full list of injuries is exported as `turtle_injuries.csv`.
Summaries by damage type and damaged body part are shown below.

### Caveats
Injured turtles with flipper amputations are more likely to be encountered, as
they nest slower.

### Frequent injuries

The numbers shown as "Damaged turtles" are absolute numbers, the percentages
shown as "Damage pct" are normalised over the number of encountered turtles 
per respective season ("Total turtles").

This summary is exported as `trt_dmg_by_species_season.csv`.

```{r dmg_type}
trt_dmg_by_species_season %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Most frequent injuries by season and species"
  ) %>% 
  gt::tab_header(
    title="Most frequent injuries by season and species",
    subtitle=""
  ) 
```

### Injury type over time
To inspect the relative abundance of each injury type per species, we show
injury abundances (as fraction of turtles seen with that damage over total
number of processed turtles in that season) over time.

This summary is exported as `trt_dmg_type_pivot.csv`.

```{r dmg_type_pivot}
trt_dmg_type_pivot %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Injuries by species over time"
  ) %>% 
  gt::tab_header(
    title="Injuries by species over time",
    subtitle="Percent of processed turtles with given damage"
  ) 
```

```{r dmg_bodypart, eval=FALSE}
# TODO make relative numbers - use total_turtles of all times
trt_dmg %>% 
  dplyr::group_by(species, body_part) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(n>1) %>%
  dplyr::arrange(species, -n) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Most frequent injured body parts by species (all seasons)"
  ) %>% 
  gt::tab_header(
    title="Most frequent injured body parts by species (all seasons)",
    subtitle="Injuries occurring more than once"
  ) 
```      

### Injured body parts over time
To inspect the relative abundance of each injured body part per species, we show
injury abundances (as fraction of turtles seen with damage to that body part 
over total number of processed turtles in that season) over time.

This summary is exported as `trt_dmg_bodypart_pivot.csv`.

```{r dmg_bodypart_pivot}
trt_dmg_bodypart_pivot %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Injuries to body parts by species over time"
  ) %>% 
  gt::tab_header(
    title="Injuries to body parts by species over time",
    subtitle="Percent of processed turtles with given damaged body part"
  )  
```


```{r dmg_both, eval=FALSE}
# TODO normalise
trt_dmg %>% 
  dplyr::group_by(species, body_part, damage) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(n>2) %>%
  dplyr::arrange(species, -n) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Most frequent injuries by species (all seasons)"
  ) %>% 
  gt::tab_header(
    title="Most frequent injuries by species (all seasons)",
    subtitle="Injuries occurring more than twice"
  ) 
```


## Predation and Disturbance
Predation and disturbance is recorded through WAStD as either general disturbance
and stand-alone signs of predator presence, or as disturbed or predated nests.

Each distinct cause of predation or disturbance is recorded separately.

### Disturbance and nest predation

<!-- TODO save to CSV: explain wastd export  -->
Nest and general disturbances are exported as `nest_dist.csv`. 
One record therein refers to one distinct disturbance or predation of one nest 
or one distinct sign of general disturbance or predator presence.

```{r}
x$nest_dist %>% 
  wastdr::disturbance_by_season() %>% 
  dplyr::arrange(-season, encounter_type, -n) %>% 
  janitor::clean_names(case = "sentence") %>% 
  rt()
```

### General disturbance
Data is shown for all seasons.

```{r dist_map}
x$nest_dist %>% 
  dplyr::filter(encounter_encounter_type == "other") %>% 
  wastdr::map_dist()
```

### Disturbed nests
Data is shown for all seasons.

```{r dist_map_nest}
x$nest_dist %>% 
  dplyr::filter(encounter_encounter_type == "nest") %>% 
  wastdr::map_dist()
```
