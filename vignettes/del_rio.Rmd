---
title: "Delambre Island  Flatback Turtle Monitoring Report - Appendix 1: Data"
author: "NWSFTCP, DBCA"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 10
    fig_height: 6
    code_folding: hide
    theme: lumen
vignette: >
  %\VignetteIndexEntry{wastd}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
params:
  area_name: 'Delambre Island'
editor_options: 
  markdown: 
    wrap: 72
---

```{css, echo=FALSE}
body, .main-container {max-width: 100%; margin-left: auto; margin-right: auto;}
```

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
library(wastdr)
library(sparkline)

# WAStD data from ETL
drake::loadd("wastd_data")

# WAMTRAM data from manual export
# https://dpaw.sharepoint.com/teams/TurtlesRioTinto/Shared%20Documents/Forms/AllItems.aspx?viewid=737abde6%2D72b7%2D4293%2D92d3%2D4e1db0bfaf3a&id=%2Fteams%2FTurtlesRioTinto%2FShared%20Documents%2FGeneral%2F2021%2D03%2D26%20DEL%20and%20WPTP%2FTagging%20data%20export%20%2D%20new%20format
# data export new format saved to data/wamtram.csv
species_lookup <- tibble::tribble(
  ~ species_code, ~ species,
  "HK", "eretmochelys-imbricata",
  "FB", "natator-depressus",
  "LB", "dermochelys-coriacea", 
  "GN", "chelonia-mydas"
) 

w2 <- here::here("data/wamtram.csv") %>% 
  readr::read_csv() %>% 
  janitor::clean_names() %>% 
  dplyr::left_join(species_lookup, by="species_code") %>% 
  dplyr::mutate(
    o_time = observed_time %>% tidyr::replace_na("00:00:00") %>% as.character(),
    o_datetime = glue::glue("{observation_date} {o_time} +08:00"),
    encounter_datetime_utc = lubridate::parse_date_time(
      o_datetime, 
      orders = c("dmYHMSz", "dmYz"), 
      tz="UTC"
      ) %>% lubridate::with_tz("UTC")
  ) %>% 
  wastdr::add_dates(date_col = "encounter_datetime_utc", parse_date = FALSE)

# Verify that dates are correct:
# w2 %>% 
#   dplyr::select(
#     observation_date, 
#     observed_time, 
#     o_time,
#     datetime, # same as encounter_datetime_utc
#     encounter_datetime_utc, 
#     calendar_date_awst, 
#     turtle_date) %>% 
#   View()
#   
# R> w2$datetime[[1]]
# [1] "1987-11-25 05:18:00 UTC"
# R> w2$encounter_datetime_utc[[1]] %>% lubridate::with_tz("Australia/Perth")
# [1] "1987-11-25 13:18:00 AWST"

# cols(
#   TURTLE_ID = col_double(),
#   SPECIES_CODE = col_character(),
#   IDENTIFICATION_CONFIDENCE = col_character(),
#   SEX = col_logical(),
#   TURTLE_STATUS = col_character(),
#   OBSERVATION_ID = col_double(),
#   OBSERVATION_STATUS = col_character(),
#   TAG_1 = col_character(),
#   TAG_2 = col_character(),
#   TAG_3 = col_character(),
#   TAG_4 = col_character(),
#   PIT_TAGS = col_character(),
#   OTHER_IDENTIFICATION = col_character(),
#   LOCATION_CODE = col_character(),
#   OBSERVATION_DATE = col_character(),
#   OBSERVED_TIME = col_time(format = ""),
#   OBSERVED_LOCATION_CODE = col_character(),
#   PLACE_CODE = col_character(),
#   ACTIVITY_CODE = col_character(),
#   BEACH_POSITION_CODE = col_character(),
#   NESTING = col_character(),
#   CLUTCH_COMPLETED = col_character(),
#   NUMBER_OF_EGGS = col_double(),
#   EGG_COUNT_METHOD = col_character(),
#   COMMENTS = col_character(),
#   CCL = col_double(),
#   CCW = col_double(),
#   DATUM_CODE = col_character(),
#   LATITUDE = col_double(),
#   LONGITUDE = col_double(),
#   LATITUDE_DEGREES = col_logical(),
#   LATITUDE_MINUTES = col_logical(),
#   LATITUDE_SECONDS = col_logical(),
#   LONGITUDE_DEGREES = col_logical(),
#   LONGITUDE_MINUTES = col_logical(),
#   LONGITUDE_SECONDS = col_logical(),
#   ZONE = col_double(),
#   EASTING = col_double(),
#   NORTHING = col_double(),
#   DAMAGE = col_character()
# )

# Rendered tables: gt
# Interactive tables: reactable
rt <- . %>% 
  reactable::reactable(
    ., 
    filterable = T, 
    sortable = T, 
    searchable = T,
    defaultColDef = reactable::colDef(html = TRUE)
  )

# Data export destination
zipfn <- wastdr::urlize(params$area_name)
fn <- here::here("inst/reports/rio", zipfn)
if (!fs::file_exists(fn)) {
  "Creating dir {fn}" %>% glue::glue() %>% wastdr::wastdr_msg_info()
  fs::dir_create(fn, recurse = TRUE)
}

# Data labels
pn <- params$area_name
pf <- "DEL"
ld <- here::here("inst/reports/delambre-island")

x <- wastd_data %>% 
  wastdr::filter_wastd_turtledata(area_name = params$area_name)

# A Missed during tagging from "missed" and from morning track count
missed_turtles <- 
  x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  dplyr::filter(
    nest_type %in% c(
      "successful-crawl", 
      "false-crawl", 
      "track-unsure", 
      "track-not-assessed")
  ) %>% 
  dplyr::group_by(season, site_name, turtle_date, species) %>% 
  dplyr::tally(name = "missed") %>% 
  dplyr::ungroup() 
 
# B Tagged from night tagging
# TODO split into tagged and missed
# 
# unique(w2$turtle_status)
# new tag:
# "A" new tag
# "P" query new tagged
# "Q" query identity
# "T" tagged
# "R" re-entered population - original
# 
# not "NEW TAG L"
# "N" non tagged
# NA  
# C captive
# E error data not to be used
# s salvage

tagged_turtles <- w2 %>% 
  dplyr::group_by(season, turtle_date, species) %>% 
  dplyr::tally(name = "tagged") %>% 
  dplyr::ungroup()

# Join A+B
total_turtles <- dplyr::full_join(
  missed_turtles,
  tagged_turtles,
  by=c("species", "season", "turtle_date")
)

# Tally A
missed_turtles_season_totals <- missed_turtles %>% 
  dplyr::group_by(site_name, season, species) %>% 
  dplyr::tally(name = "missed") %>% 
  dplyr::ungroup() 

# Tally B
tagged_turtles_season_totals <- tagged_turtles %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::tally(name = "tagged") %>% 
  dplyr::ungroup() 

# Join Tally A and Tally B
total_turtles_season <- 
  dplyr::full_join(
  missed_turtles_season_totals,
  tagged_turtles_season_totals,
  by=c("species", "season")
) %>% 
  dplyr::arrange(-season, species)
```

# Data

In this report, we present combined Turtle Monitoring data from WAStD
(Turtle Nesting Census, "tracks") and the tagging database WAMTRAM2
(Turtle Tagging, "tagging") and filter the data to the location
`r params$area_name`.

The WAStD data was downloaded on `r wastd_data$downloaded_on` and
reflects all QA operations up to this date.

The WAMTRAM2 data was exported on 26 Feb 2021.

# Survey effort
Survey effort as shown here is calculated from tracks.

The season length spans the dates of the first to the last survey of the season.
The single survey with a single turtle track in Aug 2019 contribute to the
unusual season length in 2019.

The estimate of hours spent surveying is inflated in past seasons (2019 and earlier)
by incorrectly merged surveys which span either two night tagging shifts, or
a night tagging shift and a morning track count. The estimate of hours will be
more accurate after these merged surveys have been un-merged.

```{r survey_effort}
x$surveys %>% 
  wastdr::survey_season_stats()  %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Seasonal overview of survey effort"
  ) %>% 
  # gt::fmt_date(c("First day", "Last day")) %>% # Friday, October 20, 2017
  gt::tab_header(
    title="Seasonal overview of survey effort",
    subtitle="Survey stats grouped by rookery and season"
  )
```

```{r svy_plt_count}
x$surveys %>% plot_survey_count(placename = pn, prefix = pf, export = FALSE)
```

```{r svy_plt_hrs}
x$surveys %>% plot_survey_effort(placename = pn, prefix = pf, export = FALSE)
```

<!--
# List individual surveys with links to WAStD
# x$surveys %>% survey_show_detail() %>% rt

# Survey effort: numbers
# x$surveys %>% surveys_per_site_name_and_date() %>% rt
# x$surveys %>% list_survey_count()
# x$surveys %>% survey_hours_per_site_name_and_date() %>% rt
# x$surveys %>% list_survey_effort()
# x$surveys %>% survey_hours_per_person() %>% rt
# Heatmaps break on calendar years
# x$surveys %>% survey_count_heatmap(placename = pn, prefix = pf, export = FALSE)
# x$surveys %>% survey_hours_heatmap(placename = pn, prefix = pf, export = FALSE)
-->

# Nesting

## Season overview
Nesting census data (WAStD tracks) are shown for the last season (2020-21). 
Training records are excluded.

```{r tracks_map_2020}
x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  wastdr::filter_wastd_season(2020) %>% 
  wastdr::map_tracks(sites = x$sites, cluster = FALSE)
```


<!-- 
# TODO: show tagging in tracks_map_2020
-->

The season summary provides season totals for each species, broken into
the different levels of nesting success that were captured. See also
heading "Nesting Success".

<!-- 
# TODO add tagging numbers to season_summary

# wastd_nesting_type_by_season_age_species %>%
#   readr::write_csv(here::here(fn, "nesting_type_by_season_age_species.csv"))
-->

```{r season_summary}

```

<!-- 

# 
# nest_type_by_day <- x$tracks %>% 
#   wastdr::filter_realspecies() %>% 
#   dplyr::group_by(site_name, season, calendar_date_awst, nest_type) %>% 
#   dplyr::tally() %>% 
#   dplyr::ungroup()
#  
# ggplot2::ggplot(
#   data = nest_type_by_day,
#   mapping = ggplot2::aes(
#     x = tdate_as_fdate(calendar_date_awst), 
#     colour = nest_type
#   ) 
# ) +
#   ggplot2::geom_bar(ggplot2::aes(y = n),
#                     stat = "identity",
#                     color = "black",
#                     fill = "grey"
#   ) +
#   ggplot2::facet_grid(facets = ggplot2::vars(season), scales = "free_x") +
#   ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
#   NULL

SFO https://github.com/dbca-wa/wastd/issues/177

TABLE:

-   Total, mean, SD and range number of processed turtles
-   Total, mean, SD and range number of unique individuals
-   Total, mean, SD and range number of new turtles 
-   Total, mean, SD and range number of remigrants
-   Mean, SD, range of number of missed turtles per night, and
    percentage of missed turtles per night (compared to number of
    processed turtles)
-   Total, mean, SD and range number of nests (need to discuss
    methodology to QA data to identify nests)
-   Total, mean, SD and range number of false crawls
-   mean, SD and range nesting success
-   keep figure “Number of processed turtles per day” but add number of 
    missed turtles per day to the figure, staked histograms
-   add figure “Number of new and remigrant turtles per day” : 
    show the number of new turtles and remigrants each day (unique sighting, 
    not observations)
-   add figure “Nesting success”: show the number of false crawls and nests 
    each day + dashed line showing the mean

Inter-nesting interval and clutch frequency

TABLE:

-   mean, SD, range of inter-nesting interval in days + number of animals
-   mean, SD, range of clutch frequency
-   hide figure “nesting intervals”
-   add figure “Clutch Frequency”: show estimated number of turtles that lay 1 clutch, 2 clutches, 3 clutches, etc
 -->

## Total turtles per night

We calculate the **total number of turtles per night** as the sum of
emergences from the following observations:

-   nesting females tagged at night (from WAMTRAM tagging)
-   tracks of turtles missed during tagging, tracks encountered during
    tagging (from WAStD tracks of type "false-crawls" or
    "successful-crawls" with track age "missed just now")
-   tracks of turtles missed during tagging, tracks encountered during a
    nesting census beach walk the next morning (from WAStD tracks,
    tracks of type "false-crawls" or "successful-crawls" with track age
    "new, made in past 24 hours")

We exclude hatched nests, incubating nests without a track (older than a
day), and body pits (which can be recorded, but are of little value).

We assume each record in WAMTRAM is a turtle emergence, be it tagged or not, and
nesting or not.

We bin the numbers for tallying by the "turtle date", which is the
calendar date of the tagging night and extends to encounters past
midnight and on the next morning. Turtle date rolls over at noon. Turtle
date bins all observations following one nesting night under one date.

#### Caveats

The same turtle can emerge multiple times per night. E.g., a turtle
could emerge one or several times for an unsuccessful nesting attempt
before being processed after a successful one. Another turtle could
emerge one or several times and evade tagging altogether. In either
scenario, one turtle would contribute several emergences to a night's
tally. Therefore, the numbers presented here are an **optimistic
estimate** of total turtle numbers.

<!--  

TODO Verify - are missed tracks of pre-WAStD seasons entered in WAMTRAM? 

TODO this should be total numbers - not split by tagged vs missed

# Static (too long)
# total_turtles %>%
#   dplyr::filter(species == "natator-depressus") %>%
#   dplyr::select(-site_name, -species) %>%
#   janitor::clean_names(case="sentence") %>%
#   gt::gt(groupname_col=NULL, caption = "Total Flatback emergences") %>%
#   gt::tab_header(title="Total Flatback emergences", subtitle="")
-->

```{r total_turtles}
# TODO - total turtles per night as table and figure
```

## Processed vs missed turtles
Data:
* All species from seasons 2008-09 and onwards.
* Processed turtles: WAMTRAM records indicating successful tagging
* Missed turtles: WAMTRAM records indicating tracks from a missed turtle, 
  the track being either encountered during night tagging or during a morning
  survey.

The tally of processed (tagged) and missed turtles is shown first as an
interactive table, then as a time series plot.

<!-- TODO split WAMTRAM into tagged and non tagged -->

```{r proc_vs_missed}
total_turtles_season %>%
  dplyr::select(-site_name) %>% 
  # tidyr::pivot_longer(cols=c(missed, tagged), names_to="type", values_to="n") %>%
  dplyr::filter(season > 2007) %>% # , species == "natator-depressus"
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence") %>% 
  rt()
```

### All species

```{r total_turtles_fig, fig.height=12}
ggplot2::ggplot(
  data = total_turtles,
  mapping = ggplot2::aes(x = tdate_as_fdate(turtle_date))
) +
  ggplot2::geom_bar(ggplot2::aes(y = missed),
                    stat = "identity",
                    color = "black",
                    fill = "black"
  ) +
    ggplot2::geom_bar(ggplot2::aes(y = tagged),
                    stat = "identity",
                    color = "grey",
                    fill = "grey"
  ) +
  ggplot2::facet_grid(facets = ggplot2::vars(season), scales = "free_x") +
  ggplot2::scale_x_continuous(labels = function(x) {fdate_as_tdate(x)}) +
  ggplot2::ggtitle(label="Total turtles", 
                   subtitle="Tagged vs missed by season") + 
  ggplot2::labs(x="Date", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL
```

### Recent seasons split by species

```{r proc_vs_missed_fig, fig.height=12}
total_turtles_season %>%
  tidyr::pivot_longer(cols=c(missed, tagged), names_to="type", values_to="n") %>%
  dplyr::filter(season > 2007) %>% # , species == "natator-depressus"
  janitor::clean_names(case="sentence") %>% 
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x=Season, y=N, colour=Type, fill=Type)) +
  ggplot2::facet_grid(facets = ggplot2::vars(Species), scales="free_x") +
  ggplot2::ggtitle(label="Total turtles", 
                   subtitle="Tagged vs missed by season") + 
  ggplot2::labs(x="Date", y="Turtles") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.position="bottom") +
  NULL
```

## Recaptured vs new turtles

<!--
        # resighted
        "P": 'resighted',
        "p": 'resighted',  # typo duplicate of P
        "P_OK": 'resighted',  # tag seen, good fix observed
        "P_ED": 'resighted',  # resighted, but tag about to fall off
        "RQ": 'resighted',  # observed but insecure, action taken unknown
        "RC": 'reclinched',  # observed insecure, reclinched
        "OX": 'reclinched',

        # applied-new
        "A1": 'applied-new',  # applied new, fix seems ok
        "AE": 'applied-new',  # applied new, end clinch noted
        "ae": 'applied-new',  # typo duplicate of AE

        # removed
        "R": 'removed',  # removed by obs
        "OO": 'removed',  # fell off during observation

        # not tagged, no tags seen, no number recorded:
        # "A2": '',  # TODO no tag applied
        "PX": 'resighted',  # TODO tag present, not read
        # "0": '',  # TODO false ID as lost
        "#": 'applied-new',  # tag was applied, but tag number unknown
        "Q": 'applied-new',  # tag number incompletely recorded
        # M tag scar seen
        # M1 missing
        # N not recorded
        # 0L falsely assumed to be tag scar, not a tag scar
        'resighted': 'resighted'
        
TAG_STATUS_DEFAULT = 'resighted'
TAG_STATUS_APPLIED_NEW = 'applied-new'
TAG_STATUS_CHOICES = (                                          # TRT_TAG_STATES
    ('ordered', 'ordered from manufacturer'),
    ('produced', 'produced by manufacturer'),
    ('delivered', 'delivered to HQ'),
    ('allocated', 'allocated to field team'),
    (TAG_STATUS_APPLIED_NEW, 'applied new'),                    # A1, AE
    (TAG_STATUS_DEFAULT, 're-sighted associated with animal'),  # OX, P, P_OK, RQ, P_ED
    ('reclinched', 're-sighted and reclinched on animal'),      # RC
    ('removed', 'taken off animal'),                            # OO, R
    ('found', 'found detached'),
    ('returned', 'returned to HQ'),
    ('decommissioned', 'decommissioned'),
    ('destroyed', 'destroyed'),
    ('observed', 'observed in any other context, see comments'), )

TAG_STATUS_RESIGHTED = ('resighted', 'reclinched', 'removed')
TAG_STATUS_ON_ANIMAL = (TAG_STATUS_APPLIED_NEW, TAG_STATUS_RESIGHTED)

NEST_TAG_STATUS_CHOICES = (
    (TAG_STATUS_APPLIED_NEW, 'applied new'),
    (TAG_STATUS_DEFAULT, 're-sighted associated with nest'),
)

# w2$turtle_status %>% unique() 
# "T" tag scar?
# "Q" question - incorrect read?
# "N" not recorded
# "P" re-sighted
# NA  
# "A" applied new?
# "R" removed

-->
WAMTRAM tagging records are grouped by season, species, and observation status
(initial nesting, remigrant, resighting, initial sighting) and tallied.

```{r trt_mcr}
turtles_mcr <- w2 %>% 
  # dplyr::filter(species_code == "FB") %>% 
  dplyr::group_by(season, species, observation_status) %>% 
  dplyr::tally() %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-season, species) %>% 
  tidyr::pivot_wider(names_from = observation_status, values_from = n) %>% 
  janitor::clean_names(case="sentence") 

turtles_mcr %>% 
gt::gt(
    groupname_col=NULL,
    caption = "Recapture status by season and species"
  ) %>% 
  gt::tab_header(
    title="Recapture status by season and species"
    # subtitle="Initial nesting vs Remigrant vs Resighting vs Initial sighting"
  )
```

## Remigrants

-   Add figure "remigration interval": show the number of remigrants
    coming back after 1,2,3, 4+ years
-   Add text about remigrant turtles coming from other rookeries

## Morphometrics
Tagging data fields `w2$ccl` and `w2$ccw` are grouped by season and species, 
summarised into mean, sd, min, max, and rounded to two decimals.

These summary statistics of curved carapace length and width in mm are shown below.

```{r morph}
trt_morph <- w2 %>% 
  dplyr::group_by(season, species) %>% 
  dplyr::summarise(
    ccl_mean = mean(ccl) %>% round(2),
    ccl_sd = sd(ccl) %>% round(2),
    ccl_min = min(ccl) %>% round(2),
    ccl_max = max(ccl) %>% round(2),
    ccw_mean = mean(ccw) %>% round(2),
    ccw_sd = sd(ccw) %>% round(2),
    ccw_min = min(ccw) %>% round(2),
    ccw_max = max(ccw) %>% round(2)
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence")

trt_morph %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Morphometrics by season and species"
  ) %>% 
  gt::tab_header(
    title="Morphometrics by season and species",
    subtitle="Values in millimetres, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Curved Carapace Length (mm)",
    columns = c(gt::contains("ccl"))
  ) %>% gt::tab_spanner(
    label = "Curved Carapace Width (mm)",
    columns = c(gt::contains("ccw"))
  )

```

## Nesting success

We calculate the **nesting success** as the fraction of confirmed nests
(turtles observed laying during tagging plus "successful crawl" turtle
tracks with what is believed by the observer to be a nest) over the
total number of emergences.

As nesting success are counted:

* Tagging records with `nesting` "Y" (confirmed yes)
* Tracks with `nest_type` "successful-crawl", believed to be a nest by the observer

As unknowns are counted:

* Tagging records with `nesting` "U" (unsure of nesting) and "P" (unknown)
* Tracks with `nest_type` "track-not-assessed" (did not check for nest),
  and `track-unsure` (checked but unsure)
  
As non nesting are counted:

* Tagging records with `nesting` "N" (confirmed no)
* Tracks with `nest_type` "false-crawl", believed not to be a nest by the observer

#### Caveats

When calculating the nesting success as fraction of successful over total nesting, 
we lump all degrees of uncertainty about the nesting success into the
category of nesting failure. This includes the confirmed absence of a
nest ("false crawl"), but also cases where the presence of a nest is
unsure or not checked for. The value of nesting success is therefore a
**conservative estimate**. 

The data are biased (both ways) by the observers' individual ability to 
recognize a nest.

<!-- TODO spot check numbers - are non-nesting tallies missing?  -->

```{r}
wastd_nesting_type_by_season_age_species <-
  x$tracks %>% 
  wastdr::filter_realspecies() %>% 
  wastdr::nesting_type_by_area_season_species() %>% 
  dplyr::arrange(-season)

w2_nesting_type_by_season_species <- 
  w2 %>% 
  dplyr::group_by(season, species, nesting) %>% 
  dplyr::tally() %>%
  dplyr::ungroup() %>%
  tidyr::spread(nesting, n, fill = 0) %>% 
  dplyr::rename(nesting=Y, non_nesting=N, unknown_nesting=U, unsure_nesting=P)
  
total_nesting_by_season_species <-
  dplyr::full_join(
    wastd_nesting_type_by_season_age_species,
    w2_nesting_type_by_season_species,
    by=c("season", "species")
  ) %>% 
  dplyr::arrange(-season, species) %>% 
  dplyr::transmute(
    season = season,
    species = stringr::str_to_sentence(species) %>% stringr::str_replace("-"," "),
    nesting = `successful-crawl` + nesting,
    unsure = `track-not-assessed` + `track-unsure` + unsure_nesting +  unknown_nesting,
    non_nesting = `false-crawl` + non_nesting,
    nesting_success = round(nesting * 100 / (unsure+non_nesting), 2)
  )

total_nesting_by_season_species %>%
  gt::gt(
    groupname_col=NULL,
    caption = "Nesting by season and species tallied by nesting success from tagging and track data"
  ) %>% 
  gt::tab_header(
    title="Seasonal nesting totals",
    subtitle="Nesting by season and species tallied by nesting success"
  ) %>%
  gt::cols_label(
    season = "Season",
    species = "Species",
    nesting = "Nesting confirmed",
    unsure = "Nesting unsure",
    non_nesting = "Non nesting"
  )
```

<!--  TODO Build this from  total_nesting_by_season_species 
show nesting success as fraction of confirmed yes over all nesting
-->

```{r nesting success_fb, eval=FALSE}
sp <- "natator-depressus"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
sp <- "chelonia-mydas"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
sp <- "eretmochelys-imbricata"
track_success(x$tracks) %>% ggplot_track_success_by_date(sp)
track_success(x$tracks) %>% ggplot_track_successrate_by_date(sp)
```

## Hatching and emergence success
WAStD nest excavation data on clutch size, hatching and emergence success are 
grouped by season and species, then summarised into mean, sd, min, max, 
and rounded to two decimals.

<!-- SFO
add map showing locations of hatched nests throughout the season
add map showing location of excavated nests and their hatching success
Hatching success can be shown in categories
add histogram showing proportion of nests in each hatching success categories
-->

```{r hatch_succ}
x$nest_excavations %>% 
  wastdr::hatching_emergence_success() %>% 
  dplyr::mutate(
    species=stringr::str_to_sentence(species) %>% stringr::str_replace("-"," ")
  ) %>% 
  janitor::clean_names(case="sentence") %>% 
  gt::gt(
    groupname_col=NULL,
    caption = "Hatching and emergence success by season and species"
  ) %>% 
  gt::tab_header(
    title="Hatching and emergence success by season and species",
    subtitle="Values in percent, rounded to two decimals"
  ) %>% 
  gt::tab_spanner(
    label = "Clutch size",
    columns = c(gt::contains("clutch"))
  ) %>% 
  gt::tab_spanner(
    label = "Hatching success",
    columns = c(gt::contains("hatching"))
  ) %>% 
  gt::tab_spanner(
    label = "Emergence success",
    columns = c(gt::contains("emergence"))
  )

```

## Sand temperatures

# Connectivity

## Connections to foraging grounds

## Tag recoveries

Tags from Delambre rookery found elsewhere (individual)

## Satellite tracking

# Pressures and Threats

## Injuries of tagged turtles
<!-- TODO injuries  -->

## Predation and Disturbance
Predation and disturbance is recorded through WAStD as either general disturbance
and stand-alone signs of predator presence, or as disturbed or predated nests.

Each distinct cause of predation or disturbance is recorded separately.

### Disturbance and nest predation

```{r}
x$nest_dist %>% 
  wastdr::disturbance_by_season() %>% 
  dplyr::arrange(-season, encounter_type, -n) %>% 
  janitor::clean_names(case = "sentence") %>% 
  rt()
```

### General disturbance

```{r dist_map}
x$nest_dist %>% 
  dplyr::filter(encounter_encounter_type == "other") %>% 
  wastdr::map_dist()
```

### Disturbed nests

```{r dist_map_nest}
x$nest_dist %>% 
  dplyr::filter(encounter_encounter_type == "nest") %>% 
  wastdr::map_dist()
```
